#!/usr/bin/env python3

"""
Convert an unversioned pip requirements file into a versioned equivalent.

The input format is almost identical to a pip requirements file:

-   Comment lines and blank lines are passed through unchanged.
-   Lines containing a pip version specifier are passed through.
-   Lines containing only a Python package name will have the currently
    installed version appended (as reported by pip list) in pip format.

"""

import json
import os
import re
import sys
from subprocess import CalledProcessError, run
from typing import NoReturn

PROG = os.path.basename(sys.argv[0])

RE_PASSTHRU = re.compile(r'^\s*(#|\s*$)')

# Lines containing any of these are passed through
RE_PIP_VERSION_SPECIFIER = re.compile(r'(~=|==|!=|<=|>=|<|>|===)')
RE_PIP_PKG_SPEC = re.compile(
    r'^(?P<name>[A-Z0-9]|[A-Z0-9][A-Z0-9._-]*[A-Z0-9])(?P<extra>\[[A-Z0-9]+])?$', re.I
)


# ------------------------------------------------------------------------------
def abort(*args) -> NoReturn:
    """Print a message and die."""
    print(f'{PROG}:', *args, file=sys.stderr)
    exit(1)


# ------------------------------------------------------------------------------
def pcanon(name: str) -> str:
    """
    Convert a Python package name into a cannonical format.

    See: https://packaging.python.org/en/latest/specifications/name-normalization/
    """

    name = re.sub(r'[-_.]+', '-', name).lower()
    if not (m := RE_PIP_PKG_SPEC.match(name)):
        raise ValueError(f'{name}: Not a valid Python package name')
    return m.group('name')


# ------------------------------------------------------------------------------
if __name__ == '__main__':
    if len(sys.argv) != 1:
        print(f'Usage: {PROG} < unversioned-requirements > versioned')

    result = None
    try:
        result = run(
            ['python3', '-m', 'pip', 'list', '--format', 'json'],
            capture_output=True,
            check=True,
        )
    except CalledProcessError as e:
        abort(str(e))

    installed_pkgs = {pcanon(pkg['name']): pkg['version'] for pkg in json.loads(result.stdout)}

    print(f'# Auto generated by {PROG}. DO NOT EDIT THIS FILE.\n')
    for line in sys.stdin:
        line = line.rstrip()
        if RE_PASSTHRU.match(line) or RE_PIP_VERSION_SPECIFIER.search(line):
            print(line)
            continue

        pkg = line.strip()

        try:
            version = installed_pkgs[pcanon(pkg)]
        except KeyError:
            abort('Not installed:', pkg)
        else:
            print(f'{pkg}=={version}')
