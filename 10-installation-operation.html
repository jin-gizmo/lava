
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="AWS based distributed scheduler and job runner">
      
      
        <meta name="author" content="Murray Andrews">
      
      
      
        <link rel="prev" href="09-lava-state-manager.html">
      
      
        <link rel="next" href="11-lava-job-framework.html">
      
      
      <link rel="icon" href="img/lava-icons/png/256/lava-icon-256-transparent.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Installation & Operation - Lava User Guide</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="css/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lava-installation-and-operation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Lava User Guide" class="md-header__button md-logo" aria-label="Lava User Guide" data-md-component="logo">
      
  <img src="img/lava-icons/svg/256/lava-icon-256-opaque.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lava User Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installation & Operation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        

<a href="https://github.com/jin-gizmo/lava" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Lava on GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Lava User Guide" class="md-nav__button md-logo" aria-label="Lava User Guide" data-md-component="logo">
      
  <img src="img/lava-icons/svg/256/lava-icon-256-opaque.svg" alt="logo">

    </a>
    Lava User Guide
  </label>
  
    <div class="md-nav__source">
      

<a href="https://github.com/jin-gizmo/lava" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Lava on GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="01-about-lava.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About Lava
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="02-concepts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="03-architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="04-dynamodb-tables.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DynamoDB Tables
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="05-job-dispatch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Job Dispatch
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="06-jobs-job-types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Jobs & Job Types
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="07-connectors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Connectors
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="08-job-actions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Job Actions
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="09-lava-state-manager.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lava State Manager
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Installation & Operation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="10-installation-operation.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Installation & Operation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-lava-repo" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava Repo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Lava Repo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-started-with-the-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started with the Repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-quick-tour-of-the-repo" class="md-nav__link">
    <span class="md-ellipsis">
      A Quick Tour of the Repo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-in-the-build-process" class="md-nav__link">
    <span class="md-ellipsis">
      Docker in the Build Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Docker in the Build Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-local-docker-registry" class="md-nav__link">
    <span class="md-ellipsis">
      The Local Docker Registry
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oracle-client-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Oracle Client Binaries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-lava-components" class="md-nav__link">
    <span class="md-ellipsis">
      Building Lava Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building Lava Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-thunder-run-for-the-reckless" class="md-nav__link">
    <span class="md-ellipsis">
      Thunder Run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-cloudformation-templates" class="md-nav__link">
    <span class="md-ellipsis">
      Building the CFN Templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-worker-bundle-for-the-build-host" class="md-nav__link">
    <span class="md-ellipsis">
      Building for the Build Host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-worker-bundle-for-a-foreign-host" class="md-nav__link">
    <span class="md-ellipsis">
      Building for a Foreign Host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-lambda-function-code-bundles" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lambdas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-docker-images" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Docker Images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-jinlava-python-package" class="md-nav__link">
    <span class="md-ellipsis">
      Building the jinlava Python Package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-job-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lava Job Framework
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Documentation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-lava-components" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying Lava Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploying Lava Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-component-layout-in-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Component Layout in S3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-the-lava-components-to-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying to S3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-version-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Version Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-lava-realm" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Lava Realm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a Lava Realm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-realms-table" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the Realms Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-entry-to-the-realms-table" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a Realms Table Entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-lava-realm-cloudformation-template" class="md-nav__link">
    <span class="md-ellipsis">
      Realm CFN Template
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-lava-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Lava Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a Lava Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-lava-worker-cloudformation-template" class="md-nav__link">
    <span class="md-ellipsis">
      Worker CFN Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desktop-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Desktop Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-based-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Based Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-based-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      EC2 Based Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parasitic-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Parasitic Lava Workers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-lava-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Lava Locally
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing Lava Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-installation-via-pip" class="md-nav__link">
    <span class="md-ellipsis">
      Via pip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-installation-via-a-lava-install-package" class="md-nav__link">
    <span class="md-ellipsis">
      Via a Lava Install Package
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-iam-components" class="md-nav__link">
    <span class="md-ellipsis">
      Lava IAM Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava IAM Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-iam-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-iam-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-iam-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Groups
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-lava-gui" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava GUI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-worker-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava Worker Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general-configuration-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      General Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-cmd-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      cmd Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-dag-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      dag Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-db_from_s3-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      db_from_s3 Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-docker-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      docker Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-exe-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      exe Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-foreach-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      foreach Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-pkg-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      pkg Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sharepoint-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sharepoint Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sql-sqli-and-sqlv-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sql, sqli and sqlv Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sqlc-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sqlc Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-aws-connector" class="md-nav__link">
    <span class="md-ellipsis">
      aws Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-email-connector" class="md-nav__link">
    <span class="md-ellipsis">
      email Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-redshift-connector" class="md-nav__link">
    <span class="md-ellipsis">
      redshift Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-redshift-serverless-connector" class="md-nav__link">
    <span class="md-ellipsis">
      redshift-serverless Connector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-function-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Function Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Function Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-for-s3trigger" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration for s3trigger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumentation-and-monitoring-of-lava" class="md-nav__link">
    <span class="md-ellipsis">
      Instrumentation & Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Instrumentation &amp; Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heartbeats" class="md-nav__link">
    <span class="md-ellipsis">
      Heartbeats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudwatch-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      CloudWatch Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudwatch-alarms" class="md-nav__link">
    <span class="md-ellipsis">
      CloudWatch Alarms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-internal-worker-state-information" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Internal Worker State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintaining-dynamodb-table-entries" class="md-nav__link">
    <span class="md-ellipsis">
      Maintaining DynamoDB Entries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backing-up-lava-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Backing Up Lava Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-worker-management" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava Worker Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-worker-auto-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Auto Scaling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-the-worker-daemon" class="md-nav__link">
    <span class="md-ellipsis">
      Stopping the Worker Daemon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-systems-manager-support" class="md-nav__link">
    <span class="md-ellipsis">
      AWS Systems Manager Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patching-of-lava-ec2-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patching of EC2 Workers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-lava-ec2-ami" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava EC2 AMI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Lava EC2 AMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-ami-names" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-ami-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-ami-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-versions-in-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Python Versions in the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-data-for-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      User Data for the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-a-lava-worker-ec2-instance-to-use-a-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring a Worker EC2 to Use a Lava AMI
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="11-lava-job-framework.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lava Job Framework
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="12-developing-lava-jobs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developing Lava Jobs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="13-jinja-rendering-in-lava.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Jinja Rendering in Lava
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="14-enhancing-lava.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enhancing Lava
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="15-lava-and-docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lava and Docker
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="16-commands-utilities.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands & Utilities
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="17-job-framework-samples.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Job Framework Samples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="18-api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="19-cloudformation-templates.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CloudFormation Templates
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="20-faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="21-release-notes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release Notes
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="22-credits.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Credits
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="23-known-issues.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Known Issues
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-lava-repo" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava Repo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Lava Repo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-started-with-the-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started with the Repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-quick-tour-of-the-repo" class="md-nav__link">
    <span class="md-ellipsis">
      A Quick Tour of the Repo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-in-the-build-process" class="md-nav__link">
    <span class="md-ellipsis">
      Docker in the Build Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Docker in the Build Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-local-docker-registry" class="md-nav__link">
    <span class="md-ellipsis">
      The Local Docker Registry
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oracle-client-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Oracle Client Binaries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-lava-components" class="md-nav__link">
    <span class="md-ellipsis">
      Building Lava Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building Lava Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-thunder-run-for-the-reckless" class="md-nav__link">
    <span class="md-ellipsis">
      Thunder Run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-cloudformation-templates" class="md-nav__link">
    <span class="md-ellipsis">
      Building the CFN Templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-worker-bundle-for-the-build-host" class="md-nav__link">
    <span class="md-ellipsis">
      Building for the Build Host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-worker-bundle-for-a-foreign-host" class="md-nav__link">
    <span class="md-ellipsis">
      Building for a Foreign Host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-lambda-function-code-bundles" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lambdas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-docker-images" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Docker Images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-jinlava-python-package" class="md-nav__link">
    <span class="md-ellipsis">
      Building the jinlava Python Package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-job-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lava Job Framework
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Documentation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-lava-components" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying Lava Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploying Lava Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-component-layout-in-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Component Layout in S3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-the-lava-components-to-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying to S3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-version-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Version Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-lava-realm" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Lava Realm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a Lava Realm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-realms-table" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the Realms Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-entry-to-the-realms-table" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a Realms Table Entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-lava-realm-cloudformation-template" class="md-nav__link">
    <span class="md-ellipsis">
      Realm CFN Template
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-lava-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Lava Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a Lava Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-lava-worker-cloudformation-template" class="md-nav__link">
    <span class="md-ellipsis">
      Worker CFN Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desktop-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Desktop Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-based-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Based Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-based-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      EC2 Based Lava Workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parasitic-lava-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Parasitic Lava Workers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-lava-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Lava Locally
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing Lava Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-installation-via-pip" class="md-nav__link">
    <span class="md-ellipsis">
      Via pip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-installation-via-a-lava-install-package" class="md-nav__link">
    <span class="md-ellipsis">
      Via a Lava Install Package
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-iam-components" class="md-nav__link">
    <span class="md-ellipsis">
      Lava IAM Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava IAM Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-iam-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-iam-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-iam-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Groups
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-lava-gui" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava GUI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-worker-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava Worker Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general-configuration-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      General Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-cmd-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      cmd Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-dag-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      dag Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-db_from_s3-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      db_from_s3 Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-docker-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      docker Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-exe-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      exe Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-foreach-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      foreach Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-pkg-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      pkg Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sharepoint-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sharepoint Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sql-sqli-and-sqlv-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sql, sqli and sqlv Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-sqlc-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      sqlc Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-aws-connector" class="md-nav__link">
    <span class="md-ellipsis">
      aws Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-email-connector" class="md-nav__link">
    <span class="md-ellipsis">
      email Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-redshift-connector" class="md-nav__link">
    <span class="md-ellipsis">
      redshift Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-the-redshift-serverless-connector" class="md-nav__link">
    <span class="md-ellipsis">
      redshift-serverless Connector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-function-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Function Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Function Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-for-s3trigger" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration for s3trigger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumentation-and-monitoring-of-lava" class="md-nav__link">
    <span class="md-ellipsis">
      Instrumentation & Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Instrumentation &amp; Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heartbeats" class="md-nav__link">
    <span class="md-ellipsis">
      Heartbeats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudwatch-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      CloudWatch Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudwatch-alarms" class="md-nav__link">
    <span class="md-ellipsis">
      CloudWatch Alarms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-internal-worker-state-information" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Internal Worker State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintaining-dynamodb-table-entries" class="md-nav__link">
    <span class="md-ellipsis">
      Maintaining DynamoDB Entries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backing-up-lava-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Backing Up Lava Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lava-worker-management" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lava Worker Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-worker-auto-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Lava Worker Auto Scaling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-the-worker-daemon" class="md-nav__link">
    <span class="md-ellipsis">
      Stopping the Worker Daemon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-systems-manager-support" class="md-nav__link">
    <span class="md-ellipsis">
      AWS Systems Manager Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patching-of-lava-ec2-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patching of EC2 Workers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-lava-ec2-ami" class="md-nav__link">
    <span class="md-ellipsis">
      The Lava EC2 AMI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Lava EC2 AMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lava-ami-names" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-ami-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lava-ami-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Lava AMI Versions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-versions-in-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Python Versions in the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-data-for-the-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      User Data for the Lava AMI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-a-lava-worker-ec2-instance-to-use-a-lava-ami" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring a Worker EC2 to Use a Lava AMI
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lava-installation-and-operation" x-nav="Installation &amp; Operation">Lava Installation and Operation<a class="headerlink" href="#lava-installation-and-operation" title="Permanent link">&para;</a></h1>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Lava requires Python 3.9+. The minimum recommended version is 3.11.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Support for Python 3.9 ends with lava v8.2 (Klauea).</p>
</div>
<p>There are two distinct paths for deploying lava, depending on whether the goal
is to:</p>
<ol>
<li>
<p>Run a standalone, locally hosted worker for development,
    experimentation or debugging; or</p>
</li>
<li>
<p>Run a fully AWS hosted worker.</p>
</li>
</ol>
<p>Both options require the core realm / worker AWS components, such as the,
<a href="04-dynamodb-tables.html#dynamodb-tables">DynamoDB tables</a> and worker SQS queues. The first option
assumes the lava worker will run on the local desktop and hence does not require
any AWS EC2 compute resources. The second option assumes the lava worker will be
running on one or more EC2 instances.</p>
<p>A lava realm can simultaneously contain workers of both types.</p>
<p>Let's compare the two options in more detail.</p>
<table>
<thead>
<tr>
<th></th>
<th>Local Install</th>
<th>AWS Hosted</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lava repo</td>
<td>Not required. Use pre-built components.</td>
<td>Required.</td>
</tr>
<tr>
<td>Realm AWS components</td>
<td>Required.</td>
<td>Required.</td>
</tr>
<tr>
<td>Worker AWS components</td>
<td>Minimal (worker SQS queue, KMS keys, S3 etc). No EC2.</td>
<td>Required, including IAM, EC2 etc.</td>
</tr>
<tr>
<td>Worker compute</td>
<td>Local PC native (macOS, Linux) or one of the pre-built lava docker images. See <a href="15-lava-and-docker.html#running-lava-in-docker">Running Lava in Docker</a>.</td>
<td>AWS EC2 instances based on the <a href="#the-lava-ec2-ami">lava AMI</a>.</td>
</tr>
<tr>
<td>Worker code deploy</td>
<td>Basically <code>pip install</code> or <code>docker run</code>. See <a href="#desktop-lava-workers">Desktop Lava Workers</a> and <a href="#docker-based-lava-workers">Docker Based Lava Workers</a>.</td>
<td>A fully self-contained lava code bundle is placed in S3 for workers to find and install on boot. No <code>pip install</code>. Can't have production hanging on PyPI.</td>
</tr>
<tr>
<td>Worker startup</td>
<td>Manual.</td>
<td>Fully automated.</td>
</tr>
<tr>
<td>Worker security</td>
<td>Permissions determined by the desktop user's AWS IAM profile.</td>
<td>Permissions determined by dedicated IAM components created for the realm / worker.</td>
</tr>
<tr>
<td>Suitable for production</td>
<td>No.</td>
<td>Yes.</td>
</tr>
<tr>
<td>Suitable for multi-user</td>
<td>No.</td>
<td>Yes.</td>
</tr>
<tr>
<td>AWS Costs</td>
<td>Negligible for light usage.</td>
<td>Primarily EC2 costs.</td>
</tr>
</tbody>
</table>
<p>A quick navigator for both install options is provided below. Subsequent
sections provide a lot more detail.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Local Install</label><label for="__tabbed_1_2">AWS Hosted Install</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Installation of a locally hosted lava worker follows these steps:</p>
<ol>
<li><a href="#creating-a-lava-realm">Create a lava realm</a>.</li>
<li><a href="#creating-a-lava-worker">Create a lava worker</a>. Follow the instructions
    for either a desktop worker or docker based worker, as appropriate.</li>
</ol>
<p>This path does not require the lava repo to be cloned. Pre-built versions of
the required components are provided, either from PyPI, or as part of a
<a href="https://github.com/jin-gizmo/lava/releases">release on GitHub</a>.</p>
</div>
<div class="tabbed-block">
<p>Installation of lava involves the following steps:</p>
<ol>
<li>Clone the <a href="#the-lava-repo">lava repo</a> and
    <a href="#getting-started-with-the-repo">initialise the build area</a>.</li>
<li><a href="#oracle-client-binaries">Download the Oracle client binaries</a>.</li>
<li><a href="#building-lava-components">Build the code bundles</a>.</li>
<li><a href="#deploying-lava-components">Deploy the code bundles</a>.</li>
<li><a href="#the-lava-ec2-ami">Build the lava EC2 AMI</a>.</li>
<li><a href="#creating-a-lava-realm">Create a lava realm</a>.</li>
<li><a href="#creating-a-lava-worker">Create a lava worker</a>. Follow the instructions
    for creating an EC2 based worker.</li>
</ol>
<p>This path does require the lava repo to be cloned. The repo provides 
automation for elements of the deployment process, including creating the
required artefact layout in S3.</p>
</div>
</div>
</div>
<hr />
<h2 id="the-lava-repo">The Lava Repo<a class="headerlink" href="#the-lava-repo" title="Permanent link">&para;</a></h2>
<h3 id="getting-started-with-the-repo">Getting Started with the Repo<a class="headerlink" href="#getting-started-with-the-repo" title="Permanent link">&para;</a></h3>
<p>The lava repo is available on <a href="https://github.com/jin-gizmo/lava">GitHub</a>.</p>
<p>After cloning the repo:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><span class="nb">cd</span><span class="w"> </span>lava
</span><span id="__span-0-2">
</span><span id="__span-0-3"><span class="c1"># Create the virtualenv and install required Python packages.</span>
</span><span id="__span-0-4"><span class="c1"># This can be rerun as needed, even with an existing virtualenv.</span>
</span><span id="__span-0-5">make<span class="w"> </span>init
</span><span id="__span-0-6">
</span><span id="__span-0-7"><span class="c1"># Activate the virtualenv</span>
</span><span id="__span-0-8"><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</span></code></pre></div>
<p>Apart from a standard UNIX-like Python development environment, the following
additional tools are required:</p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Why it's needed</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://aspell.net">aspell</a></td>
<td>Spell checking the user guide. Install it on macOS with Homebrew.</td>
</tr>
<tr>
<td><a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI v2</a></td>
<td>Used for deployment of lava components and various other things.</td>
</tr>
<tr>
<td><a href="https://www.docker.com">docker</a></td>
<td>Cross platform builds, testing and building the <a href="#building-the-lava-docker-images">lava docker images</a>. <a href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a> is just fine.</td>
</tr>
<tr>
<td><a href="https://developer.hashicorp.com/packer">packer</a></td>
<td>Building the <a href="#the-lava-ec2-ami">lava AMI</a>.</td>
</tr>
<tr>
<td><a href="https://www.shellcheck.net">shellcheck</a></td>
<td>Used as part of pre-commit checks. Install it on macOS with Homebrew.</td>
</tr>
<tr>
<td><a href="https://github.com/XAMPPRocky/tokei">tokei</a></td>
<td>Required to count lines of code (optional). Install it on macOS with Homebrew.</td>
</tr>
</tbody>
</table>
<p>The Oracle basic client and SQL*Plus are also required.
See <a href="#oracle-client-binaries">Oracle Client Binaries</a>.</p>
<h3 id="a-quick-tour-of-the-repo">A Quick Tour of the Repo<a class="headerlink" href="#a-quick-tour-of-the-repo" title="Permanent link">&para;</a></h3>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-1-1"><span class="err">.</span>
</span><span id="__span-1-2"><span class="err"></span><span class="w"> </span><span class="err">ami</span><span class="w">                         </span><span class="err">|</span><span class="w"> </span><span class="err">Code</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">AMI</span>
</span><span id="__span-1-3"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">conf.d</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span><span class="err">Reusable</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">script</span><span class="w"> </span><span class="err">components</span>
</span><span id="__span-1-4"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">deploy</span><span class="w"> </span><span class="err">-&gt;</span><span class="w"> </span><span class="err">../deploy</span><span class="w">     </span><span class="err">|</span>
</span><span id="__span-1-5"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">os</span><span class="w">                      </span><span class="err">|</span><span class="w"> </span><span class="err">Build</span><span class="w"> </span><span class="err">scripts</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">various</span><span class="w"> </span><span class="err">target</span><span class="w"> </span><span class="err">O/S</span>
</span><span id="__span-1-6"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">resources</span><span class="w">               </span><span class="err">|</span><span class="w"> </span><span class="err">Local</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">used</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">build</span>
</span><span id="__span-1-7"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">resources.s3</span><span class="w">            </span><span class="err">|</span><span class="w"> </span><span class="err">Larger</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">used</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">synced</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">S3</span>
</span><span id="__span-1-8"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-9"><span class="err"></span><span class="w"> </span><span class="err">bin</span><span class="w">                         </span><span class="err">|</span><span class="w"> </span><span class="err">Source</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">CLI</span><span class="w"> </span><span class="err">utilities</span>
</span><span id="__span-1-10"><span class="err"></span><span class="w"> </span><span class="err">cfn</span><span class="w">                         </span><span class="err">|</span><span class="w"> </span><span class="err">CloudFormation</span><span class="w"> </span><span class="err">templates</span><span class="w"> </span><span class="err">(raw</span><span class="w"> </span><span class="err">form</span><span class="w"> </span><span class="err">only</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">see</span><span class="w"> </span><span class="err">dist/cfn)</span>
</span><span id="__span-1-11"><span class="err"></span><span class="w"> </span><span class="err">deploy</span><span class="w">                      </span><span class="err">|</span><span class="w"> </span><span class="err">YAML</span><span class="w"> </span><span class="err">config</span><span class="w"> </span><span class="err">files</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">deploying</span><span class="w"> </span><span class="err">into</span><span class="w"> </span><span class="err">AWS</span><span class="w"> </span><span class="err">accounts</span>
</span><span id="__span-1-12"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-13"><span class="err"></span><span class="w"> </span><span class="err">dev-tools</span><span class="w">                   </span><span class="err">|</span>
</span><span id="__span-1-14"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">templates</span><span class="w">               </span><span class="err">|</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">templates</span><span class="w"> </span><span class="err">(auto</span><span class="w"> </span><span class="err">built</span><span class="w"> </span><span class="err">into</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">guide)</span>
</span><span id="__span-1-15"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-16"><span class="err"></span><span class="w"> </span><span class="err">dist</span><span class="w">                        </span><span class="err">|</span><span class="w"> </span><span class="err">Ephemeral</span><span class="w"> </span><span class="err">directory</span><span class="w"> </span><span class="err">created</span><span class="w"> </span><span class="err">by</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">process</span><span class="w"> </span><span class="err">(ex-repo)</span>
</span><span id="__span-1-17"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">ami</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Manifests</span><span class="w"> </span><span class="err">produced</span><span class="w"> </span><span class="err">by</span><span class="w"> </span><span class="err">AMI</span><span class="w"> </span><span class="err">builds</span>
</span><span id="__span-1-18"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">cfn</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">CloudFormation</span><span class="w"> </span><span class="err">templates</span><span class="w"> </span><span class="err">ready</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">deploy</span>
</span><span id="__span-1-19"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">dev-tools</span><span class="w">               </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">framework</span><span class="w"> </span><span class="err">builds</span>
</span><span id="__span-1-20"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">doc</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">guide</span><span class="w"> </span><span class="err">builds</span>
</span><span id="__span-1-21"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">lambda</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">Lambda</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">builds</span><span class="w"> </span><span class="err">(zip</span><span class="w"> </span><span class="err">files)</span>
</span><span id="__span-1-22"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">jinlava</span><span class="w">                 </span><span class="err">|</span><span class="w"> </span><span class="err">Builds</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">jinlava</span><span class="w"> </span><span class="err">Python</span><span class="w"> </span><span class="err">package</span>
</span><span id="__span-1-23"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">pkg</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">install</span><span class="w"> </span><span class="err">package</span><span class="w"> </span><span class="err">builds</span><span class="w"> </span><span class="err">by</span><span class="w"> </span><span class="err">O/S</span>
</span><span id="__span-1-24"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">test</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Unit</span><span class="w"> </span><span class="err">test</span><span class="w"> </span><span class="err">coverage</span><span class="w"> </span><span class="err">cache</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">reports</span>
</span><span id="__span-1-25"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-26"><span class="err"></span><span class="w"> </span><span class="err">doc</span><span class="w">                         </span><span class="err">|</span>
</span><span id="__span-1-27"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">img</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Images</span><span class="w"> </span><span class="err">referenced</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">guide</span>
</span><span id="__span-1-28"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">img.src</span><span class="w">                 </span><span class="err">|</span>
</span><span id="__span-1-29"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">mkdocs</span><span class="w">                  </span><span class="err">|</span>
</span><span id="__span-1-30"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">user-guide</span><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">guide</span><span class="w"> </span><span class="err">source</span>
</span><span id="__span-1-31"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-32"><span class="err"></span><span class="w"> </span><span class="err">docker</span><span class="w">                      </span><span class="err">|</span><span class="w"> </span><span class="err">Source</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">building</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">docker</span><span class="w"> </span><span class="err">images</span>
</span><span id="__span-1-33"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">common</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span><span class="err">Common</span><span class="w"> </span><span class="err">(O/S</span><span class="w"> </span><span class="err">independent)</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">components</span>
</span><span id="__span-1-34"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">os</span><span class="w">                      </span><span class="err">|</span><span class="w"> </span><span class="err">O/S</span><span class="w"> </span><span class="err">dependent</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">components</span>
</span><span id="__span-1-35"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">pkg</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">External</span><span class="w"> </span><span class="err">packages</span><span class="w"> </span><span class="err">required</span><span class="w"> </span><span class="err">(e.g.</span><span class="w"> </span><span class="err">Oracle)</span>
</span><span id="__span-1-36"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-37"><span class="err"></span><span class="w"> </span><span class="err">etc</span><span class="w">                         </span><span class="err">|</span><span class="w"> </span><span class="err">Tools</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">utilities</span><span class="w"> </span><span class="err">needed</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">maintain</span><span class="w"> </span><span class="err">lava</span>
</span><span id="__span-1-38"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">boot</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Boot</span><span class="w"> </span><span class="err">scripts</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">EC2</span><span class="w"> </span><span class="err">instances</span><span class="w"> </span><span class="err">running</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">worker</span>
</span><span id="__span-1-39"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">builders</span><span class="w">                </span><span class="err">|</span><span class="w"> </span><span class="err">Dockerfiles</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">building</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">foreign</span><span class="w"> </span><span class="err">platforms</span>
</span><span id="__span-1-40"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">git-hooks</span><span class="w">               </span><span class="err">|</span>
</span><span id="__span-1-41"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-42"><span class="err"></span><span class="w"> </span><span class="err">external-packages</span><span class="w">           </span><span class="err">|</span><span class="w"> </span><span class="err">External</span><span class="w"> </span><span class="err">non-Python</span><span class="w"> </span><span class="err">packages</span><span class="w"> </span><span class="err">that</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">requires</span>
</span><span id="__span-1-43"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">oracle</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span>
</span><span id="__span-1-44"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-45"><span class="err"></span><span class="w"> </span><span class="err">lambda</span><span class="w">                      </span><span class="err">|</span><span class="w"> </span><span class="err">Source</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">Lambda</span><span class="w"> </span><span class="err">functions</span>
</span><span id="__span-1-46"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">dispatch</span><span class="w">                </span><span class="err">|</span>
</span><span id="__span-1-47"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">metrics</span><span class="w">                 </span><span class="err">|</span>
</span><span id="__span-1-48"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">s3trigger</span><span class="w">               </span><span class="err">|</span>
</span><span id="__span-1-49"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">stop</span><span class="w">                    </span><span class="err">|</span>
</span><span id="__span-1-50"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-51"><span class="err"></span><span class="w"> </span><span class="err">lava</span><span class="w">                        </span><span class="err">|</span><span class="w"> </span><span class="err">Source</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">lava</span>
</span><span id="__span-1-52"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">connection</span><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">connector</span><span class="w"> </span><span class="err">handlers</span>
</span><span id="__span-1-53"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">handlers</span><span class="w">                </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">type</span><span class="w"> </span><span class="err">handlers</span>
</span><span id="__span-1-54"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">lib</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Miscellaneous</span><span class="w"> </span><span class="err">library</span><span class="w"> </span><span class="err">utilities</span>
</span><span id="__span-1-55"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">resources</span><span class="w">               </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">framework</span><span class="w"> </span><span class="err">source</span>
</span><span id="__span-1-56"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-57"><span class="err"></span><span class="w"> </span><span class="err">misc</span><span class="w">                        </span><span class="err">|</span><span class="w"> </span><span class="err">Miscallaneous</span><span class="w"> </span><span class="err">components,</span><span class="w"> </span><span class="err">boot</span><span class="w"> </span><span class="err">scripts</span><span class="w"> </span><span class="err">etc</span>
</span><span id="__span-1-58"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">boot</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Boot</span><span class="w"> </span><span class="err">scriptlets</span><span class="w"> </span><span class="err">called</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">root.boot.sh</span>
</span><span id="__span-1-59"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">boot.optional</span><span class="w">           </span><span class="err">|</span><span class="w"> </span><span class="err">Optional</span><span class="w"> </span><span class="err">boot</span><span class="w"> </span><span class="err">scriptlets</span>
</span><span id="__span-1-60"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">ssm</span><span class="w">                     </span><span class="err">|</span><span class="w"> </span><span class="err">Legacy</span><span class="w"> </span><span class="err">CFN</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">SSM</span><span class="w"> </span><span class="err">command</span><span class="w"> </span><span class="err">documents</span>
</span><span id="__span-1-61"><span class="err"></span><span class="w">   </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="err">.</span><span class="w"> </span>
</span><span id="__span-1-62"><span class="err"></span><span class="w"> </span><span class="err">test</span><span class="w">                        </span><span class="err">|</span><span class="w"> </span><span class="err">Lava</span><span class="w"> </span><span class="err">units</span><span class="w"> </span><span class="err">tests</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">test</span><span class="w"> </span><span class="err">jobs</span><span class="w"> </span><span class="err">(gnarly)</span>
</span><span id="__span-1-63"><span class="w">    </span><span class="err"></span><span class="w"> </span><span class="err">data</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Test</span><span class="w"> </span><span class="err">data</span><span class="w"> </span><span class="err">(e.g.</span><span class="w"> </span><span class="err">used</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">populate</span><span class="w"> </span><span class="err">test</span><span class="w"> </span><span class="err">DBs)</span>
</span><span id="__span-1-64"><span class="w">    </span><span class="err"></span><span class="w"> </span><span class="err">jobs</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Test</span><span class="w"> </span><span class="err">jobs,</span><span class="w"> </span><span class="err">connectors</span><span class="w"> </span><span class="err">etc</span><span class="w"> </span><span class="err">(lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">framework</span><span class="w"> </span><span class="err">fmt)</span>
</span><span id="__span-1-65"><span class="w">    </span><span class="err"></span><span class="w"> </span><span class="err">services</span><span class="w">                </span><span class="err">|</span><span class="w"> </span><span class="err">Data</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">Docker</span><span class="w"> </span><span class="err">compose</span><span class="w"> </span><span class="err">services</span><span class="w"> </span><span class="err">used</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">testing</span>
</span><span id="__span-1-66"><span class="w">    </span><span class="err"></span><span class="w"> </span><span class="err">unit</span><span class="w">                    </span><span class="err">|</span><span class="w"> </span><span class="err">Unit</span><span class="w"> </span><span class="err">test</span><span class="w"> </span><span class="err">source</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On macOS, you may want to add the <code>dist</code> and <code>external-packages</code> directories
to the exclusion list for Time Machine backups. They can get pretty big and
it's all ephemeral.</p>
</div>
<h2 id="docker-in-the-build-process">Docker in the Build Process<a class="headerlink" href="#docker-in-the-build-process" title="Permanent link">&para;</a></h2>
<p>Docker is used as part of the build process for a number of lava components,
either because of a requirement to match the characteristics of the target
deployment environment, need for specialised tools, or because the build product
itself is a docker artefact.</p>
<p>Components that use docker as part of the build process include:</p>
<ul>
<li>the <a href="#building-the-lava-worker-bundle-for-a-foreign-host">lava worker installation bundle</a></li>
<li>the <a href="15-lava-and-docker.html#docker-images-for-lava">lava docker images</a></li>
<li>the lava Lambda functions</li>
<li>lava tests for docker based resources (databases etc).</li>
</ul>
<p>This has all been developed using <a href="https://www.docker.com/products/docker-desktop/">Docker
Desktop</a> on macOS. Your mileage
may vary on other platforms. These are the suggested settings in <a href="https://www.docker.com/products/docker-desktop/">Docker
Desktop</a> on macOS.</p>
<p><img alt="" src="img/docker-config.png" /></p>
<h3 id="the-local-docker-registry">The Local Docker Registry<a class="headerlink" href="#the-local-docker-registry" title="Permanent link">&para;</a></h3>
<p>The build process sometimes requires multi-platform docker images to provide
both x86 and ARM support. This in turn requires a docker registry to which these
multi-platform images can be pushed as part of the build process. Unlike single
platform images that can be built and then pushed to a registry in separate
steps, multi-platform images <em>must</em> be built and pushed in a single step.</p>
<p>The lava build process will start a local docker registry in a container as, and
when, required as <code>localhost:5001</code>. This is managed using the <strong>jindr</strong> tool
which is installed as part of the <a href="#getting-started-with-the-repo">lava repo setup</a>.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1">jindr<span class="w"> </span>--help
</span><span id="__span-2-2"><span class="c1"># Start the local registry manually, if required</span>
</span><span id="__span-2-3">jindr<span class="w"> </span>start
</span><span id="__span-2-4"><span class="c1"># The registry will continue to run until manually stopped</span>
</span><span id="__span-2-5">jindr<span class="w"> </span>stop
</span><span id="__span-2-6"><span class="c1"># List the images in the registry</span>
</span><span id="__span-2-7">jindr<span class="w"> </span>images
</span><span id="__span-2-8"><span class="c1"># Copy an image to ECR (latest + 8.1.0 tags)</span>
</span><span id="__span-2-9">jindr<span class="w"> </span>copy2ecr<span class="w"> </span>localhost:5001/build/lava/amzn2023-py3.11:latest<span class="w"> </span><span class="m">8</span>.1.0
</span></code></pre></div>
<h2 id="oracle-client-binaries">Oracle Client Binaries<a class="headerlink" href="#oracle-client-binaries" title="Permanent link">&para;</a></h2>
<p>Lava's <a href="07-connectors.html#connector-type-oracle">oracle</a> connector requires the Oracle Instant
Client. The following packages are required:</p>
<ul>
<li>Basic Light or Basic</li>
<li>SQL*Plus</li>
</ul>
<p>The ZIP format for these must be downloaded from
<a href="https://www.oracle.com/database/technologies/instant-client/downloads.html">Oracle</a>
and placed in <code>external-packages/oracle</code> <strong>before any lava components are
built</strong>. There is a particular layout required.  To download or update the
required bundles run the following from the top of the repository.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1">make<span class="w"> </span>oracle
</span></code></pre></div>
<h2 id="building-lava-components">Building Lava Components<a class="headerlink" href="#building-lava-components" title="Permanent link">&para;</a></h2>
<p>The build process is controlled by GNU <em>make</em>. To get help on the build process,
run:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1">make<span class="w"> </span><span class="nb">help</span>
</span><span id="__span-4-2"><span class="c1"># ... or ...</span>
</span><span id="__span-4-3">make
</span></code></pre></div>
<p>These are the primary build targets controlled from the top level Makefile:</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cfn</code></td>
<td>The <a href="#building-the-cloudformation-templates">lava CloudFormation templates</a>.</td>
</tr>
<tr>
<td><code>preview</code></td>
<td>The <a href="#building-the-lava-documentation">lava documentation</a>, including the lava user guide and the API documentation. This will build the user guide and open a browser window to preview it locally.</td>
</tr>
<tr>
<td><code>lambda</code></td>
<td>The <a href="#building-the-lava-lambda-function-code-bundles">lava Lambda function code bundles</a>.</td>
</tr>
<tr>
<td><code>jinlava</code></td>
<td>The <a href="#building-the-jinlava-python-package">jinlava Python package</a>.</td>
</tr>
<tr>
<td><code>pkg</code></td>
<td>The lava worker code bundles. Additional parameters on the <em>make</em> command control whether the bundle is intended for the <a href="#building-the-lava-worker-bundle-for-the-build-host">build host</a> or a <a href="#building-the-lava-worker-bundle-for-a-foreign-host">foreign host</a>.</td>
</tr>
<tr>
<td><code>tools</code></td>
<td>The <a href="#building-the-lava-job-framework">lava job framework</a>.</td>
</tr>
</tbody>
</table>
<p>These components are built by running <em>make</em> in one of the subdirectories:</p>
<ul>
<li>the <a href="#the-lava-ec2-ami">lava AMI</a> (<code>ami/</code>)</li>
<li><a href="#building-the-lava-docker-images">lava docker images</a> (<code>docker/</code>).</li>
</ul>
<h3 id="a-thunder-run-for-the-reckless">A Thunder Run for the Reckless<a class="headerlink" href="#a-thunder-run-for-the-reckless" title="Permanent link">&para;</a></h3>
<p>This is a quick summary of a typical build sequence. <strong><em>Please read the full
section</em></strong> before launching into this. You, and possibly everyone who tries to
use the mess you create, will be sorry if you don't.</p>
<p>This process will leave lots of artefacts in the <code>dist</code> directory.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><span class="c1"># If you are using a private PyPI server, set that here.</span>
</span><span id="__span-5-2"><span class="c1"># Do not rely on pip.conf.</span>
</span><span id="__span-5-3"><span class="nb">export</span><span class="w"> </span><span class="nv">PIP_INDEX_URL</span><span class="o">=</span>...
</span><span id="__span-5-4">
</span><span id="__span-5-5"><span class="c1"># Get ready to build.</span>
</span><span id="__span-5-6">make<span class="w"> </span>init
</span><span id="__span-5-7"><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</span><span id="__span-5-8">
</span><span id="__span-5-9"><span class="c1"># Download the Oracle binaries</span>
</span><span id="__span-5-10">make<span class="w"> </span>oracle
</span><span id="__span-5-11">
</span><span id="__span-5-12"><span class="c1"># Build and preview the user guide because we all read the doco first, right?</span>
</span><span id="__span-5-13">make<span class="w"> </span>preview
</span><span id="__span-5-14">
</span><span id="__span-5-15"><span class="c1"># Make the bits that don&#39;t need a builder docker image</span>
</span><span id="__span-5-16">make<span class="w"> </span>cfn<span class="w"> </span>jinlava<span class="w"> </span>tools
</span><span id="__span-5-17">
</span><span id="__span-5-18"><span class="c1"># Make a couple of builder docker images. This will take quite a while.</span>
</span><span id="__span-5-19"><span class="c1"># The process does a full Python install from source for ARM and x86.</span>
</span><span id="__span-5-20">make<span class="w"> </span>builder<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.11
</span><span id="__span-5-21">make<span class="w"> </span>builder<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.13
</span><span id="__span-5-22">
</span><span id="__span-5-23"><span class="c1"># Make the lava worker install bundle for multiple runtimes/platforms</span>
</span><span id="__span-5-24"><span class="c1"># First ... for our build machine.</span>
</span><span id="__span-5-25">make<span class="w"> </span>pkg
</span><span id="__span-5-26"><span class="c1"># Now use our builders to build for foreign hosts.</span>
</span><span id="__span-5-27">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.11<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>linux/amd64
</span><span id="__span-5-28">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.11<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>linux/arm64
</span><span id="__span-5-29">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.13<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>linux/amd64
</span><span id="__span-5-30">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.13<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>linux/arm64
</span><span id="__span-5-31">
</span><span id="__span-5-32"><span class="c1"># Make the lambda code bundles. These need the amzn2023-py3.13 builder image.</span>
</span><span id="__span-5-33">make<span class="w"> </span>lambda
</span><span id="__span-5-34">
</span><span id="__span-5-35"><span class="c1"># Make the lava docker images. You might want to start this and head off to a</span>
</span><span id="__span-5-36"><span class="c1"># lunch.</span>
</span><span id="__span-5-37"><span class="nb">cd</span><span class="w"> </span>docker
</span><span id="__span-5-38">make<span class="w"> </span>build-all
</span><span id="__span-5-39">make<span class="w"> </span>check-all
</span><span id="__span-5-40"><span class="c1"># Make sure the images have been pushed to our local private docker registry.</span>
</span><span id="__span-5-41"><span class="c1"># This registry is on localhost:5001 and runs in a container.</span>
</span><span id="__span-5-42">jindr<span class="w"> </span>images
</span></code></pre></div>
<h3 id="building-the-cloudformation-templates">Building the CloudFormation Templates<a class="headerlink" href="#building-the-cloudformation-templates" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pre-built versions of the CloudFormation templates are provided as part of
a <a href="https://github.com/jin-gizmo/lava/releases">release on GitHub</a>.</p>
</div>
<p>Lava comes with several <a href="19-cloudformation-templates.html#cloudformation-templates">CloudFormation templates</a> to
build the core components for realms and workers. The sources for these are in
the <code>cfn</code> directory. These <strong>are not</strong> deployable as-is. The CloudFormation
templates must be built by doing:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1">make<span class="w"> </span>cfn
</span></code></pre></div>
<p>This will place ready-to-deploy versions in <code>dist/cfn/*.cfn.json</code>. Automatically
generated documentation for these is placed in the same directory as
<code>dist/cfn/*.cfn.md</code> and <code>dist/cfn/*.cfn.html</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Once more ... <strong>Do not</strong> deploy CloudFormation templates from the <code>cfn/</code>
directory. It will not work. Deploy only from <code>dist/cfn</code>.</p>
</div>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a class="autorefs autorefs-internal" href="19-cloudformation-templates.html#lava-commoncfnjson">lava-common.cfn.json</a></td>
<td>Contains the common components that are not realm dependent. This stack needs to be deleted and recreated for each update. This is safe to do.</td>
</tr>
<tr>
<td><a class="autorefs autorefs-internal" href="19-cloudformation-templates.html#lava-realmcfnjson">lava-realm.cfn.json</a></td>
<td>Contains the worker independent parts for creating a realm. See <a href="#creating-a-lava-realm">Creating a Lava Realm</a>.</td>
</tr>
<tr>
<td><a class="autorefs autorefs-internal" href="19-cloudformation-templates.html#lava-workercfnjson">lava-worker.cfn.json</a></td>
<td>Contains the worker dependent parts for creating a worker. The realm must already exist. See <a href="#creating-a-lava-worker">Creating a Lava Worker</a>.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>Generally</em>, it's not critical for the CloudFormation template minor
version to match the deployed lava code minor version. Major versions should
match.</p>
</div>
<h3 id="building-the-lava-worker-bundle-for-the-build-host">Building the Lava Worker Bundle for the Build Host<a class="headerlink" href="#building-the-lava-worker-bundle-for-the-build-host" title="Permanent link">&para;</a></h3>
<p>The lava worker bundle is the artefact required for a deployed lava worker. It is
a fully self-contained compressed tar file containing the lava code and includes
all of the required Python packages. As the lava worker uses some C based Python
modules, the build for the lava worker bundle must be done on the same O/S type,
Python version and platform architecture as the target deployment environment.</p>
<p>To create the lava worker code bundle to match the build host:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1">make<span class="w"> </span>pkg
</span></code></pre></div>
<p>If an alternative PyPI server is being used (e.g. a Sonatype Nexus instance),
set the environment variable <code>PIP_INDEX_URL</code> appropriately:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><span class="nv">PIP_INDEX_URL</span><span class="o">=</span>...<span class="w"> </span>make<span class="w"> </span>pkg
</span><span id="__span-8-2">
</span><span id="__span-8-3"><span class="c1"># or ...</span>
</span><span id="__span-8-4"><span class="nb">export</span><span class="w"> </span><span class="nv">PIP_INDEX_URL</span><span class="o">=</span>...
</span><span id="__span-8-5">make<span class="w"> </span>pkg
</span></code></pre></div>
<p>The build artefacts are placed in the <code>dist</code> directory as:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-9-1"><span class="err">dist/pkg/&lt;OS&gt;/lava-&lt;LAVA-VERSION&gt;-&lt;OS&gt;-&lt;PYTHON-VERSION&gt;-&lt;ARCHITECTURE&gt;.tar.bz2</span>
</span></code></pre></div>
<p>e.g.</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-10-1"><span class="err">dist/pkg/amzn2023/lava-8.1.0-amzn2023-py3.11-aarch64.tar.bz2</span>
</span><span id="__span-10-2"><span class="w">                             </span><span class="err">^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="err">^^^^^^^</span>
</span><span id="__span-10-3"><span class="w">                               </span><span class="err">&quot;runtime&quot;</span><span class="w">    </span><span class="err">&quot;platform&quot;</span><span class="w"> </span><span class="err">(as</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">host</span><span class="w"> </span><span class="err">defines</span><span class="w"> </span><span class="err">itself)</span>
</span></code></pre></div>
<h3 id="building-the-lava-worker-bundle-for-a-foreign-host">Building the Lava Worker Bundle for a Foreign Host<a class="headerlink" href="#building-the-lava-worker-bundle-for-a-foreign-host" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This process has changed in version 8.1 (Klauea). It is now possible to
build lava worker bundles for different runtimes and architectures using
<a href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a> on macOS.
The process has not been tested on other environments although it uses only
docker standard multi-platform build capabilities.</p>
</div>
<p>First, terminology:</p>
<ul>
<li><strong>Runtime</strong>: The operating system type + Python version (e.g. <code>amzn2023-py3.11</code>)</li>
<li><strong>Platform</strong>: hardware architecture. </li>
<li><strong>Foreign host</strong>: A host that differs in <em>runtime</em> or <em>platform</em> from the build host</li>
</ul>
<p>Platform terminology is quite varied, depending on context:</p>
<table>
<thead>
<tr>
<th>Platform</th>
<th>O/S terminology</th>
<th>Docker terminology</th>
<th>Oracle S/W</th>
</tr>
</thead>
<tbody>
<tr>
<td>x86</td>
<td><code>x86_64</code></td>
<td><code>linux/amd64</code></td>
<td><code>x86</code></td>
</tr>
<tr>
<td>ARM</td>
<td><code>arm64</code> (macOS) or <code>aarch64</code> (Linux)</td>
<td><code>linux/arm64</code></td>
<td><code>arm64</code></td>
</tr>
</tbody>
</table>
<p>To run a lava worker bundle on a host, the <strong>runtime and platform must match</strong>.
The build process described
<a href="#building-the-lava-worker-bundle-for-the-build-host">above</a> assumes the bundle
will be deployed on a machine with the same runtime and platform as the build
machine.</p>
<p>A foreign host build uses a docker container based on a <em>builder</em> image. The
builder images support both x86 and ARM architectures using docker
multi-platform builds.</p>
<p>The process involves two steps:</p>
<ol>
<li><a href="#building-the-builder-image">Build the builder image</a>.</li>
<li><a href="#using-the-builder-image">Use the builder image</a> to build the lava worker
   bundle.</li>
</ol>
<h4 id="building-the-builder-image">Building the builder image<a class="headerlink" href="#building-the-builder-image" title="Permanent link">&para;</a></h4>
<p>The docker builder image defines the runtime and platform for the lava worker
bundle it produces.</p>
<p>The process for "building the builder" is:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1">make<span class="w"> </span>builder<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>&lt;RUNTIME&gt;
</span><span id="__span-11-2"><span class="c1"># e.g.</span>
</span><span id="__span-11-3">make<span class="w"> </span>builder<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.11
</span></code></pre></div>
<p>This will build a multi-platform docker image supporting both <code>linux/amd64</code> and
<code>linux/arm64</code> and push it to the <a href="#the-local-docker-registry">local docker
registry</a>. The image name is:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-12-1"><span class="err">localhost:5001/build/lava/&lt;RUNTIME&gt;:latest</span>
</span></code></pre></div>
<p>e.g.</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-13-1"><span class="err">localhost:5001/build/lava/amzn2023-py3.11:latest</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The builder images incorporate a Python installation built from source (for
two different platforms) to ensure consistency. This can take a reasonable
amount of time. Be patient.</p>
</div>
<p>To see which builders are available in the local docker registry:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1">jindr<span class="w"> </span>images
</span></code></pre></div>
<p>Check the <code>etc/builders</code> directory for a list of
supported foreign runtime types. The following are currently available:</p>
<table>
<thead>
<tr>
<th>Runtime</th>
<th>Operating System</th>
<th>Python Version</th>
<th>Deprecated</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>amzn2023-py3.9</code></td>
<td>Amazon Linux 2023</td>
<td>3.9</td>
<td>Yes</td>
</tr>
<tr>
<td><code>amzn2023-py3.11</code></td>
<td>Amazon Linux 2023</td>
<td>3.11</td>
<td></td>
</tr>
<tr>
<td><code>amzn2023-py3.12</code></td>
<td>Amazon Linux 2023</td>
<td>3.12</td>
<td></td>
</tr>
<tr>
<td><code>amzn2023-py3.13</code></td>
<td>Amazon Linux 2023</td>
<td>3.13</td>
<td></td>
</tr>
<tr>
<td><code>rocky9-py3.9</code></td>
<td>Rocky Linux 9</td>
<td>3.9</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h4 id="using-the-builder-image">Using the builder image<a class="headerlink" href="#using-the-builder-image" title="Permanent link">&para;</a></h4>
<p>To build the bundles for a foreign host, first build the appropriate <a href="#building-the-builder-image">builder
image</a>, then:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>&lt;RUNTIME&gt;<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>&lt;PLATFORM&gt;
</span><span id="__span-15-2"><span class="c1"># e.g.</span>
</span><span id="__span-15-3">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>amzn2023-py3.11<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>linux/amd64
</span></code></pre></div>
<p>Once again, set <code>PIP_INDEX_URL</code> if an alternative PyPI server is being used:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><span class="nv">PIP_INDEX_URL</span><span class="o">=</span>...<span class="w"> </span>make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>&lt;RUNTIME&gt;<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>&lt;PLATFORM&gt;
</span><span id="__span-16-2">
</span><span id="__span-16-3"><span class="c1"># or ...</span>
</span><span id="__span-16-4"><span class="nb">export</span><span class="w"> </span><span class="nv">PIP_INDEX_URL</span><span class="o">=</span>...
</span><span id="__span-16-5">make<span class="w"> </span>pkg<span class="w"> </span><span class="nv">runtime</span><span class="o">=</span>&lt;RUNTIME&gt;<span class="w"> </span><span class="nv">platform</span><span class="o">=</span>&lt;PLATFORM&gt;
</span></code></pre></div>
<p>The built worker bundles are placed in the <code>dist</code> directory as:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-17-1"><span class="err">dist/pkg/&lt;OS&gt;/lava-&lt;LAVA-VERSION&gt;-&lt;OS&gt;-&lt;PYTHON-VERSION&gt;-&lt;ARCHITECTURE&gt;.tar.bz2</span>
</span></code></pre></div>
<h3 id="building-the-lava-lambda-function-code-bundles">Building the Lava Lambda Function Code Bundles<a class="headerlink" href="#building-the-lava-lambda-function-code-bundles" title="Permanent link">&para;</a></h3>
<p>The lava lambda functions are pure Python and so are not particularly sensitive
to the build platform or runtime. Nevertheless, they are built inside a docker
container derived from the <code>amzn2023-py3.13</code> builder image using the
<code>linux/arm64</code> platform. This is close enough to the deployed environment.</p>
<p>The build process is:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1">make<span class="w"> </span>lambda
</span></code></pre></div>
<p>The bundles will be placed in the directory <code>dist/lambda</code>.</p>
<h3 id="building-the-lava-docker-images">Building the Lava Docker Images<a class="headerlink" href="#building-the-lava-docker-images" title="Permanent link">&para;</a></h3>
<p>Lava comes with a suite of <a href="15-lava-and-docker.html#docker-images-for-lava">docker images</a> that are
suitable for use as base images for <a href="06-jobs-job-types.html#job-type-docker">docker</a>
jobs. The images can also be used to create containers that run the lava worker
itself.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of version 8.1 (Klauea), multi-platform (ARM and x86) images are built
by default. Docker pull operations will automatically select the platform
matching the client host unless overridden.</p>
</div>
<p>To build the multi-platform images do the following. The images will be built
and pushed to the <a href="#the-local-docker-registry">local docker registry</a> at
<code>localhost:5001</code>.</p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><span class="nb">cd</span><span class="w"> </span>docker
</span><span id="__span-19-2">
</span><span id="__span-19-3"><span class="c1"># Get help -- lots of build options. Available O/S types will be listed.</span>
</span><span id="__span-19-4">make
</span><span id="__span-19-5">
</span><span id="__span-19-6"><span class="c1"># Build all of the images. This will push the images to our local</span>
</span><span id="__span-19-7"><span class="c1"># docker registry at localhost:5001.</span>
</span><span id="__span-19-8">make<span class="w"> </span>build-all
</span><span id="__span-19-9">
</span><span id="__span-19-10"><span class="c1"># Do a fast (and flimsy) health check</span>
</span><span id="__span-19-11">make<span class="w"> </span>check-all
</span><span id="__span-19-12">
</span><span id="__span-19-13"><span class="c1"># ... or ... make a specific O/S (see docker/os directory)</span>
</span><span id="__span-19-14">make<span class="w"> </span>build<span class="w"> </span><span class="nv">os</span><span class="o">=</span>&lt;OS&gt;
</span><span id="__span-19-15">make<span class="w"> </span>check<span class="w"> </span><span class="nv">os</span><span class="o">=</span>&lt;OS&gt;
</span><span id="__span-19-16">
</span><span id="__span-19-17"><span class="c1"># Check the local registry to see the images are present</span>
</span><span id="__span-19-18">jindr<span class="w"> </span>images
</span></code></pre></div>
The images can be run locally in the normal way:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><span class="c1"># Run the image that matches the local machine architecture</span>
</span><span id="__span-20-2">docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>localhost:5001/lava/amzn2023/base
</span><span id="__span-20-3">
</span><span id="__span-20-4"><span class="c1"># Specify which platform we want. M-series Macs can run both arm64</span>
</span><span id="__span-20-5"><span class="c1"># and amd64 (under emulation)</span>
</span><span id="__span-20-6">docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>--platorm<span class="w"> </span>linux/amd64<span class="w"> </span>localhost:5001/lava/amzn2023/base
</span></code></pre></div>
<p>Prior to v8.2 (Klauea), the standard lava build process only supported use
of AWS ECR for deploying lava docker images. The images can now be deployed to
ECR or a different registry.</p>
<p>See <a href="15-lava-and-docker.html#docker-images-for-lava">Docker Images for Lava</a> for publicly available
docker images.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Deploying to ECR</label><label for="__tabbed_2_2">Deploying to another registry</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Deploying the images to AWS ECR involves creating the target repositories
and copying  the images from the <a href="#the-local-docker-registry">local docker
registry</a> to ECR.</p>
<p>First, login to AWS for command line access.</p>
<p>Create the ECR target repositories, if not already present:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1">make<span class="w"> </span>ecr-repo<span class="w"> </span><span class="nv">os</span><span class="o">=</span>...
</span><span id="__span-21-2"><span class="c1"># ... or do all at once if none of them exist yet.</span>
</span><span id="__span-21-3">make<span class="w"> </span>ecr-repo-all
</span></code></pre></div>
<p>This will also apply a lifecycle policy to the repositories to only retain 4
images, and to remove untagged images after 1 day. If this doesn't suit,
modify the policy in ECR after the repository has been created.</p>
<p>Push images to ECR:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1">make<span class="w"> </span>ecr-push<span class="w"> </span><span class="nv">os</span><span class="o">=</span>&lt;OS&gt;
</span><span id="__span-22-2"><span class="c1"># ... or push all at once</span>
</span><span id="__span-22-3">make<span class="w"> </span>ecr-push-all
</span></code></pre></div>
<p>The repositories will be created with names of the form
<code>dist/lava/&lt;OS&gt;/&lt;TYPE&gt;</code> (e.g. <code>dist/lava/amzn2023/base</code>). These <em>can</em> be
changed if it's critical, but it's best not to. The <a href="#lava-iam-policies">IAM
policies</a> created by the supplied <a href="19-cloudformation-templates.html#cloudformation-templates">CloudFormation
Templates</a> assume this structure.</p>
<p>If it's all too much to bear, the <code>dist</code> prefix can be overridden, thus:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1">make<span class="w"> </span>ecr-repo<span class="w"> </span><span class="nv">os</span><span class="o">=</span>...<span class="w"> </span><span class="nv">prefix</span><span class="o">=</span>...
</span><span id="__span-23-2">make<span class="w"> </span>ecr-push<span class="w"> </span><span class="nv">os</span><span class="o">=</span>...<span class="w"> </span><span class="nv">prefix</span><span class="o">=</span>...
</span></code></pre></div>
<p>Additional, custom IAM policies will need to be attached to the <a href="#lava-iam-groups">lava IAM
groups</a> to provide users with access.</p>
</div>
<div class="tabbed-block">
<p>Deploying the images to a docker registry involves creating the target 
repositories (if required by the registry), and copying the images from the
local docker registry to the target registry.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples in this section assume Github Container Registry (ghcr.io)
for an account named <code>my-github</code>.
Update the examples as appropriate.</p>
</div>
<p>First, login to the registry. The makefile will not do that for you.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><span class="c1"># Yes, I know, GHCR ignores the username but you get the idea.</span>
</span><span id="__span-24-2">docker<span class="w"> </span>login<span class="w"> </span>ghcr.io<span class="w"> </span>-u<span class="w"> </span>my-github
</span></code></pre></div>
<p>If the target registry requires creation of repositories prior to pushing
images, that must be done manually. GHCR doesn't require this. Don't forget
to create a repository for both <code>base</code> and <code>full</code> images.</p>
<p>Repositories should be named like so:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1">&lt;PREFIX&gt;/lava/&lt;OS&gt;/base
</span><span id="__span-25-2">&lt;PREFIX&gt;/lava/&lt;OS&gt;/full
</span></code></pre></div>
<p>e.g. The public images are named like so:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1">ghcr.io/jin-gizmo/amzn2023/base
</span><span id="__span-26-2">---+--- ----+---- ----+--- -+--
</span><span id="__span-26-3">   |        |         |     |
</span><span id="__span-26-4">registry    |         OS    |
</span><span id="__span-26-5">         prefix           type
</span></code></pre></div>
<p>Push the images:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1">make<span class="w"> </span>push<span class="w"> </span><span class="nv">registry</span><span class="o">=</span>ghcr.io<span class="w"> </span><span class="nv">prefix</span><span class="o">=</span>my-github
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="building-the-jinlava-python-package">Building the jinlava Python Package<a class="headerlink" href="#building-the-jinlava-python-package" title="Permanent link">&para;</a></h3>
<p>The <strong>jinlava</strong> package is a standard Python package that can be installed using
pip. This is handy when developing lava jobs using an IDE such as PyCharm. Full
API documentation is also available.</p>
<p>The package includes the lava APIs and all of the CLI components and utilities.</p>
<p>To build a source distribution of the <strong>jinlava</strong> package:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1">make<span class="w"> </span>jinlava
</span></code></pre></div>
<p>In Python programs, this is imported as <code>lava</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><span class="kn">import</span><span class="w"> </span><span class="nn">lava</span>
</span><span id="__span-29-2">
</span><span id="__span-29-3"><span class="nb">print</span><span class="p">(</span><span class="n">lava</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="building-the-lava-job-framework">Building the Lava Job Framework<a class="headerlink" href="#building-the-lava-job-framework" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pre-built versions of the lava job framework are (for now) provided as part
of a <a href="https://github.com/jin-gizmo/lava/releases">release on GitHub</a>. However,
the preferred mechanism is to use the <a href="16-commands-utilities.html#lava-new-utility">lava-new</a> instead.</p>
</div>
<p>The <a href="11-lava-job-framework.html#the-lava-job-framework">lava job framework</a> can be built thus:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"># From the root of the lava code repo ...
</span><span id="__span-30-2">make tools
</span></code></pre></div>
<p>The framework cookiecutter zipped bundle is placed in <code>dist/dev-tools</code>.</p>
<h3 id="building-the-lava-documentation">Building the Lava Documentation<a class="headerlink" href="#building-the-lava-documentation" title="Permanent link">&para;</a></h3>
<p>The lava user guide and API documentation can be built thus:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><span class="c1"># From the root of the lava code repo ...</span>
</span><span id="__span-31-2">make<span class="w"> </span>preview
</span></code></pre></div>
<p>This will create the user guide and open a browser window to preview it. Partial
build artefacts are placed in <code>dist/doc</code>.</p>
<p>When published, the user guide is hosted on GitHub Pages. The publishing process
is simply:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1">make<span class="w"> </span>publish
</span></code></pre></div>
<p>If the user guide is modified, it <strong>must</strong> be spell checked:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1">make<span class="w"> </span>spell
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Failure to check spelling, or, worse, recklessly adding your orthographic
ignorance to the custom dictionary will result in much wailing and gnashing
of teeth.</p>
</div>
<h2 id="deploying-lava-components">Deploying Lava Components<a class="headerlink" href="#deploying-lava-components" title="Permanent link">&para;</a></h2>
<p>The lava code bundles can be deployed in any way that suits the target
environment. However ...</p>
<p>The mechanism that is supported by the lava distribution is to place them into
AWS S3 where they can be found, either by the supplied realm CloudFormation
templates in the case of the lambda functions, or the included deployment script
and EC2 instance boot scripts in the case of the worker / dispatcher bundle.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the supplied <a href="#">CloudFormation template for a lava worker</a> is
dependent on the <a href="#the-lava-ec2-ami">lava EC2 AMI</a> because of the unusual way
it uses instance user data to run boot scripts to deploy the worker.
Sorry about that. It's a legacy thing but it works.</p>
</div>
<h3 id="lava-component-layout-in-s3">Lava Component Layout in S3<a class="headerlink" href="#lava-component-layout-in-s3" title="Permanent link">&para;</a></h3>
<p>See also: <a href="#deploying-the-lava-components-to-s3">Deploying the Lava Components to S3</a>.</p>
<p>The components must be installed in AWS S3 in a layout like this:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-34-1"><span class="err">s3://&lt;s3CodeBucket&gt;/&lt;s3CodePrefix&gt;/</span>
</span><span id="__span-34-2"><span class="err"></span><span class="w"> </span><span class="err">_ami_</span>
</span><span id="__span-34-3"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">oracle</span>
</span><span id="__span-34-4"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">instantclient-basiclite-linux-arm64.zip</span>
</span><span id="__span-34-5"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">instantclient-basiclite-linux-x64.zip</span>
</span><span id="__span-34-6"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">instantclient-sqlplus-linux-arm64.zip</span>
</span><span id="__span-34-7"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">instantclient-sqlplus-linux-x64.zip</span>
</span><span id="__span-34-8"><span class="err">|</span>
</span><span id="__span-34-9"><span class="err"></span><span class="w"> </span><span class="err">_boot_</span>
</span><span id="__span-34-10"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">10-secupdate.sh</span>
</span><span id="__span-34-11"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">50-lava.sh</span>
</span><span id="__span-34-12"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">90-motd.sh</span>
</span><span id="__span-34-13"><span class="err">|</span>
</span><span id="__span-34-14"><span class="err"></span><span class="w"> </span><span class="err">_dist_</span>
</span><span id="__span-34-15"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">cfn</span>
</span><span id="__span-34-16"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">v8.1.0</span>
</span><span id="__span-34-17"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">lava-common.cfn.json</span>
</span><span id="__span-34-18"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">lava-realm.cfn.json</span>
</span><span id="__span-34-19"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">lava-worker.cfn.json</span>
</span><span id="__span-34-20"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">lambda</span>
</span><span id="__span-34-21"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">dispatch-8.1.0.zip</span>
</span><span id="__span-34-22"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">metrics-8.1.0.zip</span>
</span><span id="__span-34-23"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">s3trigger-8.1.0.zip</span>
</span><span id="__span-34-24"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">stop-8.1.0.zip</span>
</span><span id="__span-34-25"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">pkg</span>
</span><span id="__span-34-26"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">amzn2023</span>
</span><span id="__span-34-27"><span class="err"></span><span class="w">           </span><span class="err"></span><span class="w"> </span><span class="err">lava-8.0.0-amzn2023-py3.11-x86_64.tar.bz2</span>
</span><span id="__span-34-28"><span class="err"></span><span class="w">           </span><span class="err"></span><span class="w"> </span><span class="err">lava-8.1.0-amzn2023-py3.11-aarch64.tar.bz2</span>
</span><span id="__span-34-29"><span class="err"></span><span class="w">           </span><span class="err"></span><span class="w"> </span><span class="err">lava-8.1.0-amzn2023-py3.11-x86_64.tar.bz2</span>
</span><span id="__span-34-30"><span class="err">|</span>
</span><span id="__span-34-31"><span class="err"></span><span class="w"> </span><span class="err">&lt;REALM-1&gt;</span>
</span><span id="__span-34-32"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">&lt;WORKER-1A&gt;</span>
</span><span id="__span-34-33"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">root.boot.sh</span>
</span><span id="__span-34-34"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">root.boot0.sh</span>
</span><span id="__span-34-35"><span class="err"></span><span class="w">   </span><span class="err"></span><span class="w"> </span><span class="err">&lt;WORKER-1B&gt;</span>
</span><span id="__span-34-36"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">root.boot.sh</span>
</span><span id="__span-34-37"><span class="err"></span><span class="w">       </span><span class="err"></span><span class="w"> </span><span class="err">root.boot0.sh</span>
</span><span id="__span-34-38"><span class="err">|</span>
</span><span id="__span-34-39"><span class="err"></span><span class="w"> </span><span class="err">&lt;REALM-2&gt;</span>
</span><span id="__span-34-40"><span class="w">    </span><span class="err"></span><span class="w"> </span><span class="err">&lt;WORKER-2A&gt;</span>
</span><span id="__span-34-41"><span class="w">        </span><span class="err"></span><span class="w"> </span><span class="err">root.boot.sh</span>
</span><span id="__span-34-42"><span class="w">        </span><span class="err"></span><span class="w"> </span><span class="err">root.boot0.sh</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>s3CodeBucket</code> and <code>s3CodePrefix</code> are parameters in the
<a href="#the-lava-realm-cloudformation-template">realm CloudFormation template</a>.</p>
</div>
<table>
<thead>
<tr>
<th>Prefix</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_ami_</code></td>
<td>Used by the build process for the <a href="#the-lava-ec2-ami">lava AMI</a>. It contains large packages that are baked into the lava AMI as it's quicker to get them from S3 rather than upload them to the build instance each time. It is not used in the worker boot process.</td>
</tr>
<tr>
<td><code>_boot_</code></td>
<td>These scripts are downloaded and run during the worker EC2 boot process. The critical one for the lava worker is <code>50-lava.sh</code> which downloads the worker code bundle from S3 and installs it. The source for these scripts is <code>misc/boot/</code> in the <a href="#the-lava-repo">lava repo</a>.</td>
</tr>
<tr>
<td><code>_dist_</code></td>
<td>Contains the lava distribution. Multiple lava versions can safely sit side by side in here.</td>
</tr>
<tr>
<td><code>_dist_/cfn</code></td>
<td>Contains the CloudFormation templates and associated auto-generated documentation.</td>
</tr>
<tr>
<td><code>_dist_/lambda</code></td>
<td>Contains the code bundles for the Lambda functions. Version selection is controlled by a parameter in the <a href="#the-lava-realm-cloudformation-template">realm CloudFormation template</a>.</td>
</tr>
<tr>
<td><code>_dist_/pkg</code></td>
<td>Contains the main lava worker code bundle organised by target O/S, architecture and Python version. Multiple versions are allowed. See also <a href="#lava-version-selection">Lava Version Selection</a>.</td>
</tr>
<tr>
<td><code>&lt;REALM&gt;/&lt;WORKER&gt;</code></td>
<td>Contains the worker EC2 instance primary boot scripts. While these scripts are installed on a per worker basis they should generally be identical across all accounts, realms and workers. It is possible to have a worker specific setup if required. Versions of these are provided in the <code>misc</code> directory of the <a href="#the-lava-repo">lava repo</a>. The supplied versions basically just download and run the scripts in the <code>_boot_</code> area.</td>
</tr>
</tbody>
</table>
<h3 id="deploying-the-lava-components-to-s3">Deploying the Lava Components to S3<a class="headerlink" href="#deploying-the-lava-components-to-s3" title="Permanent link">&para;</a></h3>
<p>While not mandatory, lava assumes that most environments will need to deploy all
of the built assets to AWS S3 where they can be accessed as required. This
includes the worker and dispatcher code and lambda functions. This can be
tedious to do manually so a basic deployment script is provided in
<code>etc/deploy.sh</code>.</p>
<p>It will read a YAML configuration file that tells it what to deploy and where to
deploy it. It supports deployment of the following lava components (depending
on the contents of the configuration file):</p>
<ul>
<li>
<p>S3 artefacts in the structure illustrated <a href="#lava-component-layout-in-s3">above</a>.</p>
<ul>
<li>lava code bundles (<code>_dist_/pkg/</code>)</li>
<li>boot scriptlets (<code>_boot_/</code>)</li>
<li>the lava Lambda functions (<code>_dist_/lambda/</code>)</li>
</ul>
</li>
<li>
<p>The lava job framework bundle to S3</p>
</li>
</ul>
<p>Usage is:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-35-1"><span class="err">Usage:</span><span class="w"> </span><span class="err">deploy.sh</span><span class="w"> </span><span class="err">-e</span><span class="w"> </span><span class="err">environment</span><span class="w"> </span><span class="err">[-f</span><span class="w"> </span><span class="err">deploy.yaml</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="err">[-d]</span><span class="w"> </span><span class="err">[-h]</span><span class="w"> </span><span class="err">[-n]</span><span class="w"> </span><span class="err">[component</span><span class="w"> </span><span class="err">...]</span>
</span><span id="__span-35-2">
</span><span id="__span-35-3"><span class="err">Args:</span>
</span><span id="__span-35-4"><span class="w">    </span><span class="err">-e</span><span class="w"> </span><span class="err">environment</span><span class="w">      </span><span class="err">Target</span><span class="w"> </span><span class="err">environment.</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">deploy.yaml</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="err">must</span><span class="w"> </span><span class="err">contain</span><span class="w"> </span><span class="err">a</span>
</span><span id="__span-35-5"><span class="w">                        </span><span class="err">key</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">this.</span>
</span><span id="__span-35-6">
</span><span id="__span-35-7"><span class="w">    </span><span class="err">-f</span><span class="w"> </span><span class="err">deploy.yaml</span><span class="w">      </span><span class="err">Specify</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">YAML</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="err">containing</span><span class="w"> </span><span class="err">S3</span><span class="w"> </span><span class="err">target</span><span class="w"> </span><span class="err">locations.</span><span class="w"> </span><span class="err">If</span>
</span><span id="__span-35-8"><span class="w">                        </span><span class="err">not</span><span class="w"> </span><span class="err">specified,</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">default</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">deploy.yaml</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">current</span>
</span><span id="__span-35-9"><span class="w">                        </span><span class="err">directory.</span>
</span><span id="__span-35-10">
</span><span id="__span-35-11"><span class="w">    </span><span class="err">-d</span><span class="w">                  </span><span class="err">Dry-run.</span>
</span><span id="__span-35-12">
</span><span id="__span-35-13"><span class="w">    </span><span class="err">-h</span><span class="w">                  </span><span class="err">Print</span><span class="w"> </span><span class="err">help</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">exit.</span>
</span><span id="__span-35-14">
</span><span id="__span-35-15"><span class="w">    </span><span class="err">-l</span><span class="w">                  </span><span class="err">List</span><span class="w"> </span><span class="err">deployable</span><span class="w"> </span><span class="err">components</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">exit.</span>
</span><span id="__span-35-16">
</span><span id="__span-35-17"><span class="w">    </span><span class="err">-n</span><span class="w">                  </span><span class="err">Same</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">-d</span><span class="w"> </span><span class="err">like</span><span class="w"> </span><span class="err">make(1).</span>
</span><span id="__span-35-18">
</span><span id="__span-35-19"><span class="w">    </span><span class="err">-v</span><span class="w">                  </span><span class="err">Deploy</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">specified</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">version.</span><span class="w"> </span><span class="err">If</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">specified,</span>
</span><span id="__span-35-20"><span class="w">                        </span><span class="err">the</span><span class="w"> </span><span class="err">latest</span><span class="w"> </span><span class="err">version</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">deployed</span><span class="w"> </span><span class="err">(currently</span><span class="w"> </span><span class="err">8.1.0).</span>
</span><span id="__span-35-21">
</span><span id="__span-35-22">
</span><span id="__span-35-23"><span class="w">    </span><span class="err">component</span><span class="w">           </span><span class="err">Only</span><span class="w"> </span><span class="err">deploy</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">named</span><span class="w"> </span><span class="err">components.</span><span class="w"> </span><span class="err">If</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">specified,</span><span class="w"> </span><span class="err">all</span>
</span><span id="__span-35-24"><span class="w">                        </span><span class="err">available</span><span class="w"> </span><span class="err">components</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">which</span><span class="w"> </span><span class="err">there</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">deployment</span>
</span><span id="__span-35-25"><span class="w">                        </span><span class="err">on</span><span class="w"> </span><span class="err">on</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">specification</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">deployed.</span>
</span></code></pre></div>
<p>It should be run from the base directory of the repo. A sample deployment
configuration file is provided as <code>deploy/sample.yaml</code>. Format
information is contained in that file. The script is rather basic but will
attempt to avoid copying files that aren't required in a given environment or
that don't need updating.</p>
<p>A configuration file may contain specifications for multiple environments. These
are selected by the mandatory <code>-e environment</code> of <code>etc/deploy.sh</code>. To avoid
accidents, the configuration for an environment must specify the target AWS
account ID.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The configuration file also contains parameters used to
<a href="#building-the-lava-ami">build the lava AMI</a>. These are ignored by <code>etc/config.sh</code>.</p>
</div>
<p>To list the possible deployable components run <code>etc/deploy.sh -l</code>. This will
produce something like this:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-36-1"><span class="err"></span><span class="w"> </span><span class="err">etc/deploy.sh</span><span class="w"> </span><span class="err">-l</span>
</span><span id="__span-36-2"><span class="err">ami</span><span class="w">        </span><span class="err">Components</span><span class="w"> </span><span class="err">required</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">S3</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">build</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">AMI</span><span class="w"> </span><span class="err">(not</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">AMI</span><span class="w"> </span><span class="err">itself).</span>
</span><span id="__span-36-3"><span class="err">boot</span><span class="w">       </span><span class="err">Lava</span><span class="w"> </span><span class="err">worker</span><span class="w"> </span><span class="err">boot</span><span class="w"> </span><span class="err">scriptlets</span><span class="w"> </span><span class="err">(not</span><span class="w"> </span><span class="err">root.boot*).</span>
</span><span id="__span-36-4"><span class="err">framework</span><span class="w">  </span><span class="err">Lava</span><span class="w"> </span><span class="err">job</span><span class="w"> </span><span class="err">framework.</span>
</span><span id="__span-36-5"><span class="err">lambda</span><span class="w">     </span><span class="err">Lambda</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">code</span><span class="w"> </span><span class="err">bundles.</span>
</span><span id="__span-36-6"><span class="err">pkg</span><span class="w">        </span><span class="err">Main</span><span class="w"> </span><span class="err">lava</span><span class="w"> </span><span class="err">code</span><span class="w"> </span><span class="err">package.</span>
</span></code></pre></div>
<p>A configuration file may restrict this further by not including configuration
information for some of these targets.</p>
<p>To deploy everything that is configured for a given environment:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><span class="c1"># First do a dry run to see what would be deployed ...</span>
</span><span id="__span-37-2">etc/deploy.sh<span class="w"> </span>-n<span class="w"> </span>-f<span class="w"> </span>deploy/my-config.yaml<span class="w"> </span>-e<span class="w"> </span>dev
</span><span id="__span-37-3">
</span><span id="__span-37-4"><span class="c1"># Now deploy for real ...</span>
</span><span id="__span-37-5">etc/deploy.sh<span class="w"> </span>-f<span class="w"> </span>deploy/my-config.yaml<span class="w"> </span>-e<span class="w"> </span>dev
</span></code></pre></div>
<p>Just deploy a specific component:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><span class="c1"># Deploy docs only</span>
</span><span id="__span-38-2">etc/deploy.sh<span class="w"> </span>-f<span class="w"> </span>deploy/my-config.yaml<span class="w"> </span>-e<span class="w"> </span>dev<span class="w"> </span>doc
</span></code></pre></div>
<h3 id="lava-version-selection">Lava Version Selection<a class="headerlink" href="#lava-version-selection" title="Permanent link">&para;</a></h3>
<h4 id="lambda-functions">Lambda Functions<a class="headerlink" href="#lambda-functions" title="Permanent link">&para;</a></h4>
<p>The <code>lambdaVersion</code> parameter in the <a href="#the-lava-realm-cloudformation-template">realm CloudFormation
template</a> specifies the version to use
for the lambda functions. To change versions, update the realm stack.</p>
<p>The stack will look for the lambda code in
<code>s3://&lt;s3CodeBucket&gt;/&lt;s3CodePrefix&gt;/_dist_/lambda/</code> where <code>s3CodeBucket</code>
and <code>s3CodePrefix</code> are also stack parameters.</p>
<h4 id="lava-workers">Lava Workers<a class="headerlink" href="#lava-workers" title="Permanent link">&para;</a></h4>
<p>The supplied <code>misc/boot/50-lava.sh</code> script is deployed into
<code>s3://&lt;s3CodeBucket&gt;/&lt;s3CodePrefix&gt;/_boot_/</code> and runs when the EC2 worker
instance boots.</p>
<p>By default, the script will attempt to install the highest available version
that matches the instance O/S type, Python version and architecture. However, a
specific version can be selected by <a href="#adding-worker-configuration-entries-to-the-realms-table">adding worker configuration entries to the
realms table</a>.</p>
<p>The package selection sequence is this:</p>
<ol>
<li>
<p>If a version is
    <a href="#adding-worker-configuration-entries-to-the-realms-table">specified in the realms table</a>:</p>
<ol>
<li>
<p>Look for a package with the new package naming style (i.e. version,
    O/S, architecture and Python must match). If one is found, use that.</p>
</li>
<li>
<p>Look for a package of the required version with the old naming
    style. If one is found, use that.</p>
</li>
</ol>
</li>
<li>
<p>If a version is not specified in the realms table:</p>
<ol>
<li>
<p>Find the latest matching version using the new package naming
    style. If one is found, use that.</p>
</li>
<li>
<p>Find the latest version using the old package name style. If one
    is found, use that.</p>
</li>
</ol>
</li>
<li>
<p>Otherwise, give up and abort.</p>
</li>
</ol>
<h2 id="creating-a-lava-realm">Creating a Lava Realm<a class="headerlink" href="#creating-a-lava-realm" title="Permanent link">&para;</a></h2>
<p>A lava realm is created using the following process:</p>
<ol>
<li><a href="#creating-the-realms-table">Create the realms table</a>, if it doesn't already
    exist.</li>
<li><a href="#adding-a-new-entry-to-the-realms-table">Add an entry in the realms table</a>
    for the new realm.</li>
<li><a href="#the-lava-realm-cloudformation-template">Use the realm CloudFormation template</a>
    to create the AWS resources for the realm.</li>
</ol>
<p>Once the realm is configured, there may be a few final items to perform, such as</p>
<ul>
<li>
<p>Add a resource policy to the lava realm S3 bucket, if required.</p>
</li>
<li>
<p>Add subscriptions to the realm SNS topic for event notifications.</p>
</li>
<li>
<p>Configure connections and jobs for the realm.</p>
</li>
</ul>
<h3 id="creating-the-realms-table">Creating the Realms Table<a class="headerlink" href="#creating-the-realms-table" title="Permanent link">&para;</a></h3>
<p>There is a single <a href="04-dynamodb-tables.html#the-realms-table">realms table</a> per AWS account. While it
<em>can</em> be created by the CloudFormation template that creates an individual
realm, this is not recommended as it means the resulting stack cannot be deleted
without impacting other lava realms.</p>
<p>The recommended way to create the realms table is using the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><span class="c1"># Create the realms table. ReadCapacityUnits can be adjusted now or once the</span>
</span><span id="__span-39-2"><span class="c1"># table is created. WriteCapacityUnits does not need to be changed.</span>
</span><span id="__span-39-3">
</span><span id="__span-39-4">aws<span class="w"> </span>dynamodb<span class="w"> </span>create-table<span class="w"> </span>--table-name<span class="w"> </span>lava.realms<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-5"><span class="w">    </span>--key-schema<span class="w"> </span><span class="nv">AttributeName</span><span class="o">=</span>realm,KeyType<span class="o">=</span>HASH<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-6"><span class="w">    </span>--attribute-definitions<span class="w"> </span><span class="nv">AttributeName</span><span class="o">=</span>realm,AttributeType<span class="o">=</span>S<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-7"><span class="w">    </span>--provisioned-throughput<span class="w"> </span><span class="nv">ReadCapacityUnits</span><span class="o">=</span><span class="m">3</span>,WriteCapacityUnits<span class="o">=</span><span class="m">1</span>
</span></code></pre></div>
<h3 id="adding-a-new-entry-to-the-realms-table">Adding a New Entry to the Realms Table<a class="headerlink" href="#adding-a-new-entry-to-the-realms-table" title="Permanent link">&para;</a></h3>
<p>Each realm requires an entry in the <a href="04-dynamodb-tables.html#the-realms-table">realms table</a>. This will
look something like the following: (replace <code>&lt;..&gt;</code> with the appropriate value).</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-40-1"><span class="p">{</span>
</span><span id="__span-40-2"><span class="w">  </span><span class="nt">&quot;on_fail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-40-3"><span class="w">    </span><span class="p">{</span>
</span><span id="__span-40-4"><span class="w">      </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sns&quot;</span><span class="p">,</span>
</span><span id="__span-40-5"><span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Job {{job.job_id}}@{{realm.realm}} ({{job.run_id}}) failed: {{result.error}}&quot;</span><span class="p">,</span>
</span><span id="__span-40-6"><span class="w">      </span><span class="nt">&quot;topic&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:sns:&lt;REGION&gt;:&lt;ACCOUNT_ID&gt;:lava-&lt;REALM&gt;-notices&quot;</span>
</span><span id="__span-40-7"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-8"><span class="w">  </span><span class="p">],</span>
</span><span id="__span-40-9"><span class="w">  </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;REALM&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-40-10"><span class="w">  </span><span class="nt">&quot;s3_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;alias/lava-&lt;REALM&gt;-user&quot;</span><span class="p">,</span>
</span><span id="__span-40-11"><span class="w">  </span><span class="nt">&quot;s3_payloads&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3://&lt;lavaBucketName&gt;/payloads&quot;</span><span class="p">,</span>
</span><span id="__span-40-12"><span class="w">  </span><span class="nt">&quot;s3_temp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3://&lt;lavaBucketName&gt;/tmp&quot;</span>
</span><span id="__span-40-13"><span class="p">}</span>
</span></code></pre></div>
<h3 id="the-lava-realm-cloudformation-template">The Lava Realm CloudFormation Template<a class="headerlink" href="#the-lava-realm-cloudformation-template" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pre-built versions of the CloudFormation templates are provided as part of
a <a href="https://github.com/jin-gizmo/lava/releases">release on GitHub</a>.</p>
</div>
<p>The <a href="19-cloudformation-templates.html#lava-realmcfnjson">realm CloudFormation template</a> is located in the
<a href="#the-lava-repo">lava repo</a>.
See <a href="#building-the-cloudformation-templates">Building the CloudFormation Templates</a>.</p>
<p>If the realm is going to host any workers, the 
<a href="#building-the-lava-lambda-function-code-bundles">lava lambda function code bundles</a>
must also have been built and <a href="#deploying-lava-components">deployed to S3</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible, and sometimes useful, to create a <em>bare realm</em> that will not
contain any workers. In this situation, the realm consists only of the
DynamoDB tables and a few other static components. A bare realm is useful
where an external application needs to use the lava connector subsystem via
the <a class="autorefs autorefs-internal" title="            lava.connection" href="18-api.html#lava.connection">jinlava API</a> but is not necessarily being orchestrated
to run on a lava worker.</p>
</div>
<p>The template incorporates the following resources:</p>
<ul>
<li>The realm specific <a href="04-dynamodb-tables.html#dynamodb-tables">DynamoDB tables</a>.</li>
<li>The S3 bucket for the realm that will contain job payloads and outputs.</li>
<li>Some KMS keys for the realm.</li>
<li>An SNS topic for notifications relating to the realm.</li>
<li>Lambda functions for the S3 job trigger and dispatch helper and associated
    IAM roles.</li>
<li>Realm specific <a href="#lava-iam-components">IAM components</a>.</li>
</ul>
<p>Template parameters are described below.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Version</td>
<td>Yes</td>
<td>This is a <strong>read-only</strong> informational parameter that indicates the lava version associated with the template.</td>
</tr>
<tr>
<td>autoscalingHeartbeatMinutes</td>
<td>Yes</td>
<td>Send auto scaling heartbeats at this frequency when workers are terminating. This tells the auto scaler that the worker is still busy finishing in-flight jobs and to give it more time before forced termination. The upper limit on the auto scaler's patience is set by the <code>workerStopMinutes</code> parameter.</td>
</tr>
<tr>
<td>createRealmsTable</td>
<td>Yes</td>
<td>If <code>yes</code>, the <a href="04-dynamodb-tables.html#the-realms-table">realms</a> table will be created. It's much safer to leave this set to <code>no</code> and <a href="#creating-the-realms-table">create the realms table</a> separately.</td>
</tr>
<tr>
<td>kmsKeyAdmin</td>
<td>Yes</td>
<td>The IAM user name of KMS key administrator. This gets added into the resource policy of the realm's KMS keys.</td>
</tr>
<tr>
<td>lambdaMetricsSchedule</td>
<td>Yes</td>
<td>If set to <code>ENABLED</code>, an AWS EventBridge rule fires the <code>lava-&lt;REALM&gt;-metrics</code> lambda once a minute. This lambda calculates the worker backlog metric used to manage <a href="#lava-worker-auto-scaling">lava worker auto scaling</a>.</td>
</tr>
<tr>
<td>lambdaTimeout</td>
<td>Yes</td>
<td>Timeout for the lambdas (seconds). Ignored if the lambdas are not deployed.</td>
</tr>
<tr>
<td>lambdaVersion</td>
<td>No</td>
<td>This parameter selects which code version is deployed for the Lambda functions. If left empty, the Lambda functions are not deployed.</td>
</tr>
<tr>
<td>lavaBucketName</td>
<td>Yes</td>
<td>The name of the bucket where the new realm will store job payloads and outputs. The template will create this bucket.</td>
</tr>
<tr>
<td>logBucketName</td>
<td>Yes</td>
<td>Name of S3 bucket for S3 logs.</td>
</tr>
<tr>
<td>readCapacityDataTables</td>
<td>Yes</td>
<td>Read capacity for the <a href="04-dynamodb-tables.html#dynamodb-tables">Dynamo DB data tables</a>. This excludes the <a href="04-dynamodb-tables.html#the-events-table">events</a> table and the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
<tr>
<td>readCapacityEventTable</td>
<td>Yes</td>
<td>Read capacity for the <a href="04-dynamodb-tables.html#the-events-table">events</a> table.</td>
</tr>
<tr>
<td>readCapacityStateTable</td>
<td>Yes</td>
<td>Read capacity for the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
<tr>
<td>realm</td>
<td>Yes</td>
<td>Realm name.</td>
</tr>
<tr>
<td>s3CodeBucket</td>
<td>Yes</td>
<td>The name of the bucket containing the lava code bundles.</td>
</tr>
<tr>
<td>s3CodePrefix</td>
<td>Yes</td>
<td>The prefix in the code bucket containing the lava code bundles.</td>
</tr>
<tr>
<td>tmpExpiryDays</td>
<td>Yes</td>
<td>Expire files in the temp area of the lava bucket after this many days.</td>
</tr>
<tr>
<td>workerStopMinutes</td>
<td>Yes</td>
<td>Allow workers this many minutes to stop gracefully. When a worker is instructed to shut down by its owning auto scaling group, it is given the specified amount of time to finish any in-flight jobs before the auto scaler forcibly terminates it. This value can be as high as 720 minutes (12 hours). The value should be selected in conjunction with the worker SQS queue visibility timeout.</td>
</tr>
<tr>
<td>writeCapacityDataTables</td>
<td>Yes</td>
<td>Write capacity for the <a href="04-dynamodb-tables.html#dynamodb-tables">Dynamo DB data tables</a>. This excludes the <a href="04-dynamodb-tables.html#the-events-table">events</a> table and the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
<tr>
<td>writeCapacityEventTable</td>
<td>Yes</td>
<td>Write capacity for the <a href="04-dynamodb-tables.html#the-events-table">events</a> table.</td>
</tr>
<tr>
<td>writeCapacityStateTable</td>
<td>Yes</td>
<td>Write capacity for the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
</tbody>
</table>
<h2 id="creating-a-lava-worker">Creating a Lava Worker<a class="headerlink" href="#creating-a-lava-worker" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>It is important to read <em>all</em> of this section before starting to create a
worker.</p>
</div>
<p>Each realm can have an arbitrary number of workers of different capabilities to
run jobs.</p>
<p>Workers can run on Linux / macOS with Python 3.9+ installed.</p>
<p>There are different ways to run the lava worker.
The worker can be run interactively or as a multi-threaded daemon. It is
possible to run multiple workers on a single instance. </p>
<p>The first worker created will typically also serve as a dispatcher for scheduled
jobs. Dispatcher workers must
each run in their own operating system account to ensure crontab separation.</p>
<p>Creating a worker involves two distinct aspects:</p>
<ol>
<li>
<p>Use the
    <a href="#the-lava-worker-cloudformation-template">lava worker CloudFormation template</a>
    to create the AWS resources required by the worker (e.g. SQS queue, EC2
    components etc).</p>
</li>
<li>
<p>Create a compute environment to run the actual lava worker. The most common
    options for doing this are:</p>
<ol>
<li><a href="#desktop-lava-workers">Desktop workers</a></li>
<li><a href="#docker-based-lava-workers">Docker lava workers</a></li>
<li><a href="#ec2-based-lava-workers">EC2 based workers</a></li>
<li><a href="#parasitic-lava-workers">Parasitic workers</a>.</li>
</ol>
</li>
</ol>
<h3 id="the-lava-worker-cloudformation-template">The Lava Worker CloudFormation Template<a class="headerlink" href="#the-lava-worker-cloudformation-template" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pre-built versions of the CloudFormation templates are provided as part of
a <a href="https://github.com/jin-gizmo/lava/releases">release on GitHub</a>.</p>
</div>
<p>The <a href="19-cloudformation-templates.html#lava-workercfnjson">worker CloudFormation template</a> is located in the
<a href="#the-lava-repo">lava repo</a>.
See <a href="#building-the-cloudformation-templates">Building the CloudFormation Templates</a>.</p>
<p>The lava worker CloudFormation template is a single entity but it contains
parameters (and associated resources) in three broad groups:</p>
<ol>
<li>
<p><a href="#core-worker-parameters">Core worker parameters</a>: These are necessary for
    any lava worker, unrelated to where, or whether, the worker process is
    running. e.g. the worker SQS queue, queue depth alarm etc.</p>
</li>
<li>
<p><a href="#ec2-worker-parameters">EC2 worker parameters</a>: These parameters are
    associated with the operating resources needed for an AWS EC2 instance
    running the worker process. e.g. launch configuration, auto scaling group,
    IAM role for the worker etc.</p>
</li>
<li>
<p><a href="#ec2-instance-selection-parameters">EC2 instance selection parameters</a>:
    These parameters control the way in which the EC2 instance type is chosen.</p>
</li>
</ol>
<p>These are all parameters of the same template but are described separately below
for clarity.</p>
<h4 id="core-worker-parameters">Core Worker Parameters<a class="headerlink" href="#core-worker-parameters" title="Permanent link">&para;</a></h4>
<p>The core worker parameters and associated resources are necessary for a lava
worker to exist, whether or not there is an actual worker process anywhere or
where it is located.</p>
<p>In broad terms, these relate to resources that are not EC2 related.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Version</td>
<td>This is a <strong>read-only</strong> informational parameter that indicates the lava version associated with the template.</td>
</tr>
<tr>
<td>alarmTopic</td>
<td>Name of an SNS topic for alarms. The topic must already exist.</td>
</tr>
<tr>
<td>autoscalingControlledTermination</td>
<td>If <code>ENABLED</code>, auto scaling controlled termination on worker nodes is enabled. Best not to fiddle with this.</td>
</tr>
<tr>
<td>maxAllowedQueueDepth</td>
<td>Create a CloudWatch alarm if queue depth exceeds this value. Set to 0 for no alarm.</td>
</tr>
<tr>
<td>messageRetentionPeriod</td>
<td>Message retention period on the worker SQS queue in seconds. Default 1 day. Must be &gt;= 1800 (30 minutes).</td>
</tr>
<tr>
<td>queueDepthMinutes</td>
<td>Minutes worker SQS queue depth exceeds <code>maxAllowedQueueDepth</code> before alarming.</td>
</tr>
<tr>
<td>realm</td>
<td>Name of the realm.</td>
</tr>
<tr>
<td>realmLambdasDeployed</td>
<td>Are the realm lambda functions deployed? This should almost always be set to <code>Yes</code>.</td>
</tr>
<tr>
<td>visibilityTimeout</td>
<td>Visibility timeout on the worker queue (seconds). Default 1 hour.</td>
</tr>
<tr>
<td>worker</td>
<td>Name of the worker.</td>
</tr>
</tbody>
</table>
<h4 id="ec2-worker-parameters">EC2 Worker Parameters<a class="headerlink" href="#ec2-worker-parameters" title="Permanent link">&para;</a></h4>
<p>These parameters control creation of resource required to run an EC2 based lava worker. They are triggered by setting the <code>createWorkerInstance</code> parameter to <code>Yes</code>.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>amiId</td>
<td>AWS EC2 Image ID for the worker EC2 instance. This should be the ID for a <a href="#the-lava-ec2-ami">lava AMI</a>. Can be left blank if <code>createWorkerInstance</code> is <code>No</code>.</td>
</tr>
<tr>
<td>autoscalingActionTopic</td>
<td>Name of an SNS topic for reporting normal auto scaling activity. If required, the topic must already exist.</td>
</tr>
<tr>
<td>createHeartBeatAlarm</td>
<td>If <code>Yes</code> a CloudWatch alarm will be created for a loss of heartbeat messages from a worker. Set to <code>No</code> for non-EC2 based workers.</td>
</tr>
<tr>
<td>createWorkerInstance</td>
<td>If <code>Yes</code>, the required components for an EC2 based worker will be created. Set to <code>No</code> if the worker will be running on an existing compute environment (e.g. local machine or parasitic on an existing worker).</td>
</tr>
<tr>
<td>dockerVolumeSize</td>
<td>If non-zero (GB) a dedicated EBS volume for docker will be added to an EC2 based worker. This is a good idea if the worker will be running docker jobs to isolate large storage needs for docker images.</td>
</tr>
<tr>
<td>keyPairName</td>
<td>SSH key pair to assign to EC2 based instances. If left empty, no SSH key is assigned.</td>
</tr>
<tr>
<td>rootVolumeSize</td>
<td>Size in GB of the root volume on an EC2 based instance. Set to 0 for the default value associated with the AMI. This would typically be increased if not creating a dedicated temporary volume or if swapping is enabled. See also <code>tmpVolumeSize</code> and <code>swapSize</code>.</td>
</tr>
<tr>
<td>secGroups</td>
<td>A list of (existing) EC2 security groups to attach to an EC2 based instance.</td>
</tr>
<tr>
<td>subnets</td>
<td>A list of (existing) VPC subnets in which EC2 based instances can be placed.</td>
</tr>
<tr>
<td>swapSize</td>
<td>Swap size in Gibibytes (0 = no swapping). This may require a bigger root volume. See <code>rootVolumeSize</code>.</td>
</tr>
<tr>
<td>tmpVolumeSize</td>
<td>Size in GB of a dedicated EBS volume mounted on <code>/tmp</code> for EC2 based instances. Set to 0 to remove. If the worker is going to be processing disk I/O bound jobs, a larger tmp volume may help due to increased provisioned IOPS.</td>
</tr>
<tr>
<td>workerBacklogScalingTarget</td>
<td>Auto scaling worker backlog. Set to 0 to disable backlog scaling. See <a href="#lava-worker-auto-scaling">Lava Worker Auto Scaling</a>.</td>
</tr>
<tr>
<td>workerInstancesDesired</td>
<td>The number of desired EC2 based instances. This is used by the auto scaling group.</td>
</tr>
<tr>
<td>workerInstancesMax</td>
<td>The maximum number of EC2 based instances the auto scaling group will provision.</td>
</tr>
<tr>
<td>workerInstancesMin</td>
<td>The minimum number of EC2 based instances the auto scaling group will provision.</td>
</tr>
<tr>
<td>workerPublicIp</td>
<td>Assign a public IP to the worker.</td>
</tr>
</tbody>
</table>
<h4 id="ec2-instance-selection-parameters">EC2 Instance Selection Parameters<a class="headerlink" href="#ec2-instance-selection-parameters" title="Permanent link">&para;</a></h4>
<p>The <a href="#ec2-worker-parameters">EC2 Worker Parameters</a> described above specify
<em>how</em> to create an EC2 based lava worker but they do not specify what instance
type to use. This is done by the parameters specified below.</p>
<p>Two different methods of instance type selection are supported:</p>
<ol>
<li>
<p><strong>Explicit instance type provisioning</strong>: This is triggered by setting the
    <code>workerInstanceType</code> parameter to a single EC2 instance type (e.g.
    <code>m3.large</code>).    </p>
<p>The required instance type will be specified in the worker launch template.
The advantage of this approach is that it is simple and direct. The
disadvantage is that, if AWS has a capacity shortage for the specified
instance type, the auto scaler may not be able to create a worker or fully
satisfy the auto scaler's demands. The risk of this seems to increase for
the larger instance types.</p>
</li>
<li>
<p><strong>Capability based provisioning</strong>: If <code>workerInstanceType</code> is not set, the
    other parameters are used to indicate the capabilities required of the
    worker instance.</p>
<p>These parameters control the inclusion of a <a href="https://docs.aws.amazon.com/autoscaling/ec2/APIReference/API_MixedInstancesPolicy.html">mixed instances
policy</a>
in the auto scaling group definition. No instance type information is
included in the launch template.  This gives the auto scaler the
ability to choose any instance type that meets the capability requirements.
Lava workers don't much care about instance type. They mostly care about
memory, CPU and storage.</p>
<p>The advantage of this approach is increased resilience in the face of AWS EC2
capacity shortages.</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>workerAllowedInstances</td>
<td>Comma separated list of allowed instance types (GLOBs allowed) for EC2 based workers using capability based provisioning. e.g. <code>*</code> Would allow any instance type. <code>m3.*,c3.*</code> would allow any M-series or C-series instance type that meets memory and CPU requirements. A value must be specified if <code>workerInstanceType</code> is not set.</td>
</tr>
<tr>
<td>workerBurstable</td>
<td>Include burstable instance types (e.g. T-series) for EC2 based workers using capability based provisioning.</td>
</tr>
<tr>
<td>workerInstanceType</td>
<td>If set to an AWS instance type, an EC2 based instance will use the specified type. If not set, capability provisioning will be used to select an EC2 instance type.</td>
</tr>
<tr>
<td>workerLocalStorage</td>
<td>Controls inclusion of EC2 instance types with local storage when performing capability based provisioning.</td>
</tr>
<tr>
<td>workerMemoryMax</td>
<td>Maximum memory in MiB (<em>not</em> MB) for EC2 instance types when performing capability based provisioning. Set to 0 to remove the upper limit.</td>
</tr>
<tr>
<td>workerMemoryMin</td>
<td>Minimum memory in MiB (<em>not</em> MB) for EC2 instance types when performing capability based provisioning.</td>
</tr>
<tr>
<td>workerVCpuMax</td>
<td>Maximum number of vCPUs for EC2 instance types when performing capability based provisioning. Set to 0 to remove the upper limit.</td>
</tr>
<tr>
<td>workerVCpuMin</td>
<td>Minimum number of vCPUs for EC2 instance types when performing capability based provisioning.</td>
</tr>
</tbody>
</table>
<h3 id="desktop-lava-workers">Desktop Lava Workers<a class="headerlink" href="#desktop-lava-workers" title="Permanent link">&para;</a></h3>
<p>Once the <a href="#core-worker-parameters">core worker components</a> are created for a
lava worker, it is straightforward to run the lava worker on a macOS or Linux
desktop, provided the user has the appropriate IAM permissions.</p>
<p>The setup will look something like this (not including installing non-lava
prerequisites):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><span class="c1"># Create a virtual env to be safe</span>
</span><span id="__span-41-2">mkdir<span class="w"> </span>lavaworker
</span><span id="__span-41-3"><span class="nb">cd</span><span class="w"> </span>lavaworker
</span><span id="__span-41-4">python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
</span><span id="__span-41-5"><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</span><span id="__span-41-6">
</span><span id="__span-41-7"><span class="c1"># Install</span>
</span><span id="__span-41-8">pip3<span class="w"> </span>install<span class="w"> </span>jinlava
</span><span id="__span-41-9">
</span><span id="__span-41-10"><span class="c1"># Get help</span>
</span><span id="__span-41-11">lava-worker<span class="w"> </span>--help
</span><span id="__span-41-12">
</span><span id="__span-41-13"><span class="c1"># Run a lava worker interactively for development / debugging</span>
</span><span id="__span-41-14">lava-worker<span class="w"> </span>--realm<span class="w"> </span>&lt;REALM&gt;<span class="w"> </span>--worker<span class="w"> </span>&lt;WORKER&gt;<span class="w"> </span>--level<span class="w"> </span>debug<span class="w"> </span>--dev
</span></code></pre></div>
<h3 id="docker-based-lava-workers">Docker Based Lava Workers<a class="headerlink" href="#docker-based-lava-workers" title="Permanent link">&para;</a></h3>
<p>A straightforward way to run a lava worker on a local machine is to use one of
the pre-built lava images. This will include all of the non-lava prerequisites
and all of the lava utilities, include the lava worker.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><span class="c1"># First, log in to ECR then ...</span>
</span><span id="__span-42-2">docker<span class="w"> </span>pull<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-3"><span class="w">    </span><span class="s2">&quot;&lt;ACCOUNT_NO&gt;.dkr.ecr.ap-southeast-2.amazonaws.com/dist/lava/amzn2023/base&quot;</span>
</span><span id="__span-42-4">
</span><span id="__span-42-5"><span class="c1"># Run the container</span>
</span><span id="__span-42-6">docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-7"><span class="w">    </span><span class="s2">&quot;&lt;ACCOUNT_NO&gt;.dkr.ecr.ap-southeast-2.amazonaws.com/dist/lava/amzn2023/base&quot;</span>
</span><span id="__span-42-8">
</span><span id="__span-42-9"><span class="c1"># Get help</span>
</span><span id="__span-42-10">lava-worker<span class="w"> </span>--help
</span><span id="__span-42-11">
</span><span id="__span-42-12"><span class="c1"># Setup AWS profile then ... </span>
</span><span id="__span-42-13">
</span><span id="__span-42-14"><span class="c1"># Run a lava worker interactively for development / debugging</span>
</span><span id="__span-42-15">lava-worker<span class="w"> </span>--realm<span class="w"> </span>&lt;REALM&gt;<span class="w"> </span>--worker<span class="w"> </span>&lt;WORKER&gt;<span class="w"> </span>--level<span class="w"> </span>debug<span class="w"> </span>--dev
</span></code></pre></div>
<h3 id="ec2-based-lava-workers">EC2 Based Lava Workers<a class="headerlink" href="#ec2-based-lava-workers" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the standard shared use and production configuration for a lava
worker.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The following process assumes the <a href="#building-lava-components">lava deployment
artefacts</a> and the <a href="#the-lava-ec2-ami">lava EC2
AMI</a> have already been built and <a href="#deploying-lava-components">deployed to
S3</a>. Ensure that matching Python versions and
platform architectures are selected throughout for any given worker.</p>
</div>
<p>The preferred deployment configuration for a production or shared-use lava
worker is to use the <a href="#the-lava-worker-cloudformation-template">lava worker CloudFormation
template</a> to create EC2 instances,
based on the <a href="#the-lava-ec2-ami">lava AMI</a>, running the lava worker code bundle.</p>
<p>The setup process is:</p>
<ol>
<li>
<p><a href="#deploying-the-lava-components-to-s3">Deploy the Lava Components to S3</a>
    if not already present. These will be read by the worker EC2 at boot time.</p>
</li>
<li>
<p><a href="#installing-the-worker-boot-scripts">Install the worker boot scripts</a>.
    These will be read by the worker EC2 at boot time.</p>
</li>
<li>
<p>Add
   <a href="#adding-worker-configuration-entries-to-the-realms-table">worker configuration entries</a>
   to the <a href="04-dynamodb-tables.html#the-realms-table">realms table</a> to specify the run-time
   configuration of the worker.</p>
</li>
<li>
<p>Build the <a href="#the-lava-worker-cloudformation-template">worker CloudFormation stack</a>
    with these settings:</p>
<ul>
<li><code>createWorkerInstance</code>=<code>Yes</code> </li>
<li><code>workerInstancesDesired</code>=<code>0</code></li>
<li><code>createHeartBeatAlarm</code>=<code>No</code></li>
</ul>
<p>If the <code>createWorkerInstance</code> parameter is set to <code>Yes</code> when deploying the
<a href="#the-lava-worker-cloudformation-template">lava worker CloudFormation template</a>,
additional resources are created to host a lava worker on an EC2 instance
(e.g. worker IAM role, launch template, auto scaling group etc). Setting
<code>workerInstancesDesired</code> to <code>0</code> still creates these components but no
active EC2 instances.</p>
</li>
<li>
<p>Update the worker IAM role if required.</p>
<p>The previous step will create the required EC2 resources for the worker  but
not start an EC2 instance. It will also create an IAM role
<code>lava-&lt;REALM&gt;-worker-&lt;WORKER&gt;</code> . This will contain the core permissions to
allow a worker to function. It may be necessary to add other, environment
specific policies to this before starting an actual EC2 instance.</p>
</li>
<li>
<p>If the worker is going to be a dispatcher, create a <a href="06-jobs-job-types.html#job-type-lavasched">lavasched</a>
    job in the realm jobs table. The worker <em>jump-start</em> process will
    automatically build a crontab schedule when the EC2 instance boots.</p>
</li>
<li>
<p>Update the <a href="#the-lava-worker-cloudformation-template">worker CloudFormation stack</a>
    with these changes:</p>
<ul>
<li><code>workerInstancesDesired</code>=<code>1</code></li>
<li><code>createHeartBeatAlarm</code>=<code>Yes</code></li>
</ul>
</li>
</ol>
<p>An EC2 instance will be created that can be accessed via SSM session manager. It
can take a few minutes for lava to install and start. The configuration is as
shown below:</p>
<p><img alt="lava production deployment" src="img/deploy-config.svg" /></p>
<p>The start up process for the worker is:</p>
<ol>
<li>
<p>The CloudFormation template configures the the worker auto scaling group to
    start one or more instances.</p>
</li>
<li>
<p>The worker auto scaling group starts an EC2 instance using the
    <a href="#the-lava-ec2-ami">lava AMI</a> as a base.</p>
</li>
<li>
<p>The EC2 instance reads <a href="#installing-the-worker-boot-scripts">boot scripts</a>
    from S3 and runs them.</p>
</li>
<li>
<p>The boot scripts read
    <a href="#adding-worker-configuration-entries-to-the-realms-table">worker configuration</a>
    from the realms table (lava version, how many daemons to run etc.)</p>
</li>
<li>
<p>The boot scripts read the lava code bundle from S3, install it, and configure 
    and start the lava worker daemons.</p>
</li>
</ol>
<h4 id="adding-worker-configuration-entries-to-the-realms-table">Adding Worker Configuration Entries to the Realms Table<a class="headerlink" href="#adding-worker-configuration-entries-to-the-realms-table" title="Permanent link">&para;</a></h4>
<p>By default, the EC2-based worker boot process will attempt to install the
highest available lava version that matches the host Python version and hardware
architecture. It will also start a single lava worker daemon.</p>
<p>The realms table entry can contain parameters under the <code>x-workers.&lt;WORKER&gt;</code>
key that modify the behaviour of this process as follows. Note that a <code>&lt;WORKER&gt;</code>
value of <code>_</code> in the realms table can provide defaults for all workers where
a worker specific value is not provided.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>daemons</td>
<td>Integer</td>
<td>The number of worker daemons to run. The default is 1.</td>
</tr>
<tr>
<td>env</td>
<td>Map</td>
<td>A map of variables that will be placed in the worker's environment.</td>
</tr>
<tr>
<td>threads</td>
<td>Integer</td>
<td>Number of threads to run per worker daemon.</td>
</tr>
<tr>
<td>version</td>
<td>String</td>
<td>Lava version to install (e.g. 8.1.0).</td>
</tr>
<tr>
<td>workers</td>
<td>String</td>
<td>A space separated list of workers to run. This is used for <a href="#parasitic-lava-workers">parasitic workers</a>.</td>
</tr>
</tbody>
</table>
<div class="language-json highlight"><pre><span></span><code><span id="__span-43-1"><span class="p">{</span>
</span><span id="__span-43-2"><span class="w">  </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod01&quot;</span><span class="p">,</span>
</span><span id="__span-43-3"><span class="w">  </span><span class="nt">&quot;x-workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-4"><span class="w">    </span><span class="nt">&quot;core&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-5"><span class="w">      </span><span class="nt">&quot;threads&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
</span><span id="__span-43-6"><span class="w">      </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8.1.0&quot;</span>
</span><span id="__span-43-7"><span class="w">    </span><span class="p">},</span>
</span><span id="__span-43-8"><span class="w">    </span><span class="nt">&quot;_&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-9"><span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-10"><span class="w">        </span><span class="nt">&quot;AWS_MAX_ATTEMPTS&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-43-11"><span class="w">        </span><span class="nt">&quot;AWS_METADATA_SERVICE_NUM_ATTEMPTS&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-43-12"><span class="w">        </span><span class="nt">&quot;AWS_RETRY_MODE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
</span><span id="__span-43-13">
</span><span id="__span-43-14"><span class="w">      </span><span class="p">}</span>
</span><span id="__span-43-15"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-16"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-17"><span class="p">}</span>
</span></code></pre></div>
<p>This will cause the instance to install lava version 8.1.0 on the machine and
start a worker <code>lava-prod01-core</code> running 6 threads. The worker will have the
three <code>AWS_*</code> environment variables set.</p>
<h4 id="installing-the-worker-boot-scripts">Installing the Worker Boot Scripts<a class="headerlink" href="#installing-the-worker-boot-scripts" title="Permanent link">&para;</a></h4>
<p>The worker boot scripts, <code>root.boot0.sh</code> and <code>root.boot.sh</code> configure the EC2
instance and install lava. The user data in the launch template will tell an
instance created from a <a href="#the-lava-ec2-ami">lava AMI</a> to run the boot scripts
when the worker instance boots. It will also provide the S3 location to obtain
the code.</p>
<p>The lava repository contains versions of these boot scripts in the <code>misc</code>
directory. They can be used as is or tailored as required.</p>
<p>These scripts must be placed in the same area of S3 as the lava code in
sub-prefixes specifying the realm and worker names as shown in
<a href="#lava-component-layout-in-s3">Lava Component Layout in S3</a>.</p>
<p>The supplied version of <code>root.boot.sh</code> basically just downloads and runs the
boot scripts from the <code>_boot_/</code> prefix in the
<a href="#lava-component-layout-in-s3">S3 deployment area</a>.</p>
<h3 id="parasitic-lava-workers">Parasitic Lava Workers<a class="headerlink" href="#parasitic-lava-workers" title="Permanent link">&para;</a></h3>
<p>It is possible for multiple lava workers to share a single EC2 instance. In this
case, exactly one of the workers will have an associated EC2 instance and the
other parasitic workers will hitch a ride on that.</p>
<p>The host worker is created first as described <a href="#ec2-based-lava-workers">above</a>.</p>
<p>This is the process to add a parasitic worker:</p>
<ol>
<li>
<p>Use the <a href="#the-lava-worker-cloudformation-template">lava worker CloudFormation template</a>
    to create an additional worker with <code>createWorkerInstance</code>=<code>No</code>. </p>
</li>
<li>
<p>Update the realm entry in the <a href="04-dynamodb-tables.html#the-realms-table">realms</a> table to configure
    the extra worker to run on the same host as the existing worker (see below).</p>
</li>
<li>
<p>If the parasitic worker is going to be a dispatcher, create a
    <a href="06-jobs-job-types.html#job-type-lavasched">lavasched</a> job in the realm jobs table. The worker
    <em>jump-start</em> process will automatically build a crontab schedule when it the
    EC2 instance boots.</p>
</li>
<li>
<p>Reboot or replace the EC2 instance. Both workers should now start on the one
    host.</p>
</li>
</ol>
<p>The following example shows the changes in the <a href="04-dynamodb-tables.html#the-realms-table">realms</a> table
to add a <code>core-bulk</code> worker to the primary <code>core</code> worker.</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-44-1"><span class="p">{</span>
</span><span id="__span-44-2"><span class="w">  </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod01&quot;</span><span class="p">,</span>
</span><span id="__span-44-3"><span class="w">  </span><span class="nt">&quot;x-workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-4"><span class="w">    </span><span class="nt">&quot;core&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-5"><span class="w">      </span><span class="nt">&quot;threads&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
</span><span id="__span-44-6"><span class="w">      </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8.1.0&quot;</span><span class="p">,</span>
</span><span id="__span-44-7"><span class="w">      </span><span class="nt">&quot;workers&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;core core-bulk&quot;</span>
</span><span id="__span-44-8"><span class="w">    </span><span class="p">},</span>
</span><span id="__span-44-9"><span class="w">    </span><span class="nt">&quot;core-bulk&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-10"><span class="w">      </span><span class="nt">&quot;daemons&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-44-11"><span class="w">      </span><span class="nt">&quot;threads&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
</span><span id="__span-44-12"><span class="w">      </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8.1.0&quot;</span>
</span><span id="__span-44-13"><span class="w">    </span><span class="p">},</span>
</span><span id="__span-44-14"><span class="w">    </span><span class="nt">&quot;_&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-15"><span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-16"><span class="w">        </span><span class="nt">&quot;AWS_MAX_ATTEMPTS&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-44-17"><span class="w">        </span><span class="nt">&quot;AWS_METADATA_SERVICE_NUM_ATTEMPTS&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-44-18"><span class="w">        </span><span class="nt">&quot;AWS_RETRY_MODE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;adaptive&quot;</span>
</span><span id="__span-44-19"><span class="w">      </span><span class="p">}</span>
</span><span id="__span-44-20"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-21"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-44-22"><span class="p">}</span>
</span></code></pre></div>
<p>Note the addition of <code>"workers": "core core-bulk"</code> entry in <code>workers -&gt; core</code>.
This tells the worker boot script to run an extra worker.</p>
<p>The <code>"core-bulk": { ... }</code> section specifies the configuration of this extra
(parasitic) worker.</p>
<p>Points to note:</p>
<ol>
<li>The workers can, if required, run different versions of lava.</li>
<li>The <code>"daemons": 2</code>element will start 2 workers named <code>lava-prod01-core-bulk</code>,
    each running 8 threads.</li>
<li>One worker EC2 host cannot run workers belonging to different realms.</li>
</ol>
<p>Its important to be aware of the following when running multiple worker daemons
with the same name on the same machine:</p>
<ul>
<li>This configuration is experimental.</li>
<li>They will all service the same SQS job queue.</li>
<li>They will all emit heartbeat messages under the same name.</li>
<li>They will all produce worker CloudWatch metrics for the same metrics, if that
    configuration option is enabled. See <a href="#worker-metrics">Worker Metrics</a>.</li>
</ul>
<h2 id="installing-lava-locally">Installing Lava Locally<a class="headerlink" href="#installing-lava-locally" title="Permanent link">&para;</a></h2>
<p>Lava can be installed locally on machines with an operating system (Linux /
macOS).</p>
<p>There are two ways to do this:</p>
<ol>
<li><a href="#local-installation-via-pip">Local installation via pip</a></li>
<li><a href="#local-installation-via-a-lava-install-package">Local installation via a lava install package</a>.</li>
</ol>
<h3 id="local-installation-via-pip">Local Installation via pip<a class="headerlink" href="#local-installation-via-pip" title="Permanent link">&para;</a></h3>
<p>The lava package is available as a standard Python package that can be installed
using pip. This is handy when developing lava jobs using an IDE such as PyCharm.
Full API documentation is also available. </p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1">pip<span class="w"> </span>install<span class="w"> </span>jinlava
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be aware that there is another, unrelated, lava package out there. Just
running <code>pip install lava</code> <strong>will do the wrong thing</strong> so the lava
package is bundled as <code>jinlava</code>. Python imports still use <code>import lava</code>. If
you need to use both this lava and the other one, you must have a most
unusual use case.</p>
</div>
<p>Some optional modules are available as <em>extras</em>. The following
modules are in the extras:</p>
<ul>
<li>
<p>PyGreSQL (pgdb)</p>
</li>
<li>
<p>AWS Redshift Driver</p>
</li>
<li>
<p>Pyodbc</p>
</li>
</ul>
<p>To install everything, including the optional extras:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1">pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;jinlava[extras]&quot;</span>
</span></code></pre></div>
<h3 id="local-installation-via-a-lava-install-package">Local Installation via a Lava Install Package<a class="headerlink" href="#local-installation-via-a-lava-install-package" title="Permanent link">&para;</a></h3>
<p>First, obtain (or <a href="#building-lava-components">build</a>) the code bundle for the
target O/S and machine architecture. This will include the worker and all of the
<a href="16-commands-utilities.html#lava-commands-and-utilities">lava utilities</a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For macOS, the bundle name will look something like  <br />
<code>lava-8.0.0-darwin24-py3.11-arm64.tar.bz2</code>.</p>
</div>
<p>The installation process is then:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><span class="c1"># Package name depends on lava version, O/S, Python version</span>
</span><span id="__span-47-2"><span class="c1"># and platform architecture.</span>
</span><span id="__span-47-3"><span class="nv">PKG</span><span class="o">=</span>lava-8.0.0-darwin24-py3.11-arm64.tar.bz2
</span><span id="__span-47-4">
</span><span id="__span-47-5"><span class="c1"># Extract the installer from the pkg.</span>
</span><span id="__span-47-6">tar<span class="w"> </span>xf<span class="w"> </span><span class="nv">$PKG</span><span class="w"> </span>install.sh
</span><span id="__span-47-7">
</span><span id="__span-47-8"><span class="c1"># Get help on the installer</span>
</span><span id="__span-47-9">./install.sh
</span><span id="__span-47-10">
</span><span id="__span-47-11"><span class="c1"># Do a clean install in the default location (/usr/local)</span>
</span><span id="__span-47-12">./install.sh<span class="w"> </span>-c<span class="w"> </span><span class="nv">$PKG</span>
</span><span id="__span-47-13">
</span><span id="__span-47-14"><span class="c1"># See if it works. Make sure /usr/local/bin is in your path.</span>
</span><span id="__span-47-15">lava-version
</span></code></pre></div>
<h2 id="lava-iam-components">Lava IAM Components<a class="headerlink" href="#lava-iam-components" title="Permanent link">&para;</a></h2>
<p>The lava <a href="#building-the-cloudformation-templates">CloudFormation templates</a> will
create a base set of IAM components, both for the lava workers and for users
needing to interact with the lava environment.</p>
<p>These components are described below.</p>
<h3 id="lava-iam-roles">Lava IAM Roles<a class="headerlink" href="#lava-iam-roles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lava-&lt;REALM&gt;-dispatch-lambda</code></td>
<td>Service role for the <a href="05-job-dispatch.html#the-dispatch-helper">dispatch helper</a> Lambda function.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-metrics-lambda</code></td>
<td>Service role for the Lambda function that calculates worker backlog metrics used for <a href="#lava-worker-auto-scaling">lava worker auto scaling</a>.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-s3trigger</code></td>
<td>Service role for the Lambda function that <a href="05-job-dispatch.html#dispatching-jobs-from-s3-events">dispatches jobs from S3 bucket notification events</a>.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-stop-lambda</code></td>
<td>Service role for the Lambda function that signals EC2-based lava workers to shutdown as part of an <a href="#lava-worker-auto-scaling">auto scaler scale-in process</a>.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-worker-&lt;WORKER&gt;</code></td>
<td>IAM role for EC2-based workers. It will have the <code>lava-&lt;REALM&gt;-worker</code> policy attached.</td>
</tr>
</tbody>
</table>
<h3 id="lava-iam-policies">Lava IAM Policies<a class="headerlink" href="#lava-iam-policies" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Policy</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lava-&lt;REALM&gt;-worker</code></td>
<td>Base permissions required for a worker node to function within a lava realm.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-admin</code></td>
<td>Permissions for an administrator for the realm.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-reader</code></td>
<td>Read-only access to key resources in the realm.</td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-operator</code></td>
<td>Additional permissions to that of <code>lava-&lt;REALM&gt;-reader</code>.</td>
</tr>
</tbody>
</table>
<h3 id="lava-iam-groups">Lava IAM Groups<a class="headerlink" href="#lava-iam-groups" title="Permanent link">&para;</a></h3>
<p>IAM groups using the policies described above are also provided:</p>
<table>
<thead>
<tr>
<th>Group Name</th>
<th>Policies</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lava-&lt;REALM&gt;-admin</code></td>
<td><code>lava-&lt;REALM&gt;-admin</code></td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-reader</code></td>
<td><code>lava-&lt;REALM&gt;-reader</code></td>
</tr>
<tr>
<td><code>lava-&lt;REALM&gt;-operator</code></td>
<td><code>lava-&lt;REALM&gt;-reader</code>, <code>lava-&lt;REALM&gt;-operator</code></td>
</tr>
</tbody>
</table>
<p>The groups have the following permissions, which are restricted to the lava
realm wherever possible:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th style="text-align: center;">Reader</th>
<th style="text-align: center;">Operator</th>
<th style="text-align: center;">Admin</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lava bucket</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>DynamoDB tables (realm specific)</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>DynamoDB <code>realms</code> table</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
</tr>
<tr>
<td>KMS key <code>user</code></td>
<td style="text-align: center;">Usage</td>
<td style="text-align: center;">Usage</td>
<td style="text-align: center;">Usage</td>
</tr>
<tr>
<td>KMS key <code>sys</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Usage</td>
</tr>
<tr>
<td>Lava distro docker images in ECR</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
</tr>
<tr>
<td>Payload docker images in ECR</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>EventBridge rules</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>Lava worker logs in CloudWatch</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">R</td>
</tr>
<tr>
<td>Dispatcher SNS Topic</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Publish</td>
<td style="text-align: center;">Publish</td>
</tr>
<tr>
<td>Lava Worker SQS Queues</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>SSM Parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">RW</td>
</tr>
<tr>
<td>Secrets Manager</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">RW</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The summary above is an approximation. Refer to the actual underlying IAM
policies for specifics.</p>
</div>
<h2 id="the-lava-gui">The Lava GUI<a class="headerlink" href="#the-lava-gui" title="Permanent link">&para;</a></h2>
<p>Contemporaneous with version 8.1 (Klauea), a new version of the desktop lava
GUI has been developed in Flet. The new GUI is a <em>lot</em> better than the original
(which is not high praise, but it really is heaps better). The new GUI is now a
separate project from the lava core.</p>
<p><a href="https://github.com/jin-gizmo/lava-gui">Lava GUI on GitHub</a></p>
<p>The new GUI supports macOS and Windows.</p>
<h2 id="lava-worker-configuration">Lava Worker Configuration<a class="headerlink" href="#lava-worker-configuration" title="Permanent link">&para;</a></h2>
<p>Lava worker configuration can be modified by setting a number of configuration 
variables. For a configuration variable named <code>xyz</code>, lava will use the first
value in the following sequence:</p>
<ol>
<li>An environment variable named <code>LAVA_XYZ</code></li>
<li>An <code>XYZ</code> entry under the <code>config</code> map of the
    <a href="04-dynamodb-tables.html#the-realms-table">realms table</a></li>
<li>A default value as described below.</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The environment and <a href="04-dynamodb-tables.html#the-realms-table">realms table</a> are only read when the
worker starts. Changing configuration variables requires the worker to be
restarted. Sorry.</p>
</div>
<p>In the following, a <strong>Duration</strong> is a string in the form <code>nnX</code> where <code>nn</code>
is a number and <code>X</code> is <code>s</code> (seconds), <code>m</code> (minutes) or <code>h</code> (hours), <code>d</code> (days)
or <code>w</code> (weeks).</p>
<p>A <strong>Size</strong> is a string in the form <code>nnX</code> where <code>nn</code> is a number and <code>X</code> is a
case-sensitive unit specifier:</p>
<ul>
<li><code>B</code>: Bytes (default if no unit specified)</li>
<li><code>K</code>, <code>KB</code>: Kilobytes (1000)</li>
<li><code>M</code>, <code>MB</code>: Megabytes</li>
<li><code>G</code>, <code>GB</code>: Gigabytes</li>
<li><code>T</code>, <code>TB</code>: Terabytes</li>
<li><code>P</code>, <code>PB</code>: Petabytes.</li>
<li><code>KiB</code>: Kibibytes (1024)</li>
<li><code>MiB</code>: Mebibytes</li>
<li><code>GiB</code>: Gibibytes</li>
<li><code>TiB</code>: Tebibytes</li>
<li><code>PiB</code>: Pebibytes.</li>
</ul>
<p>A <em>boolean</em> is a case-insensitive string in the form:</p>
<ul>
<li><code>true</code>, <code>t</code>, <code>yes</code>, <code>y</code> or a non-zero integer (True)</li>
<li><code>false</code>, <code>f</code>, <code>no</code>, <code>n</code> or zero (False).</li>
</ul>
<h3 id="general-configuration-parameters">General Configuration Parameters<a class="headerlink" href="#general-configuration-parameters" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHECK_FOR_ZOMBIES</td>
<td>Boolean</td>
<td>True</td>
<td>When the worker exits, it waits for all the job threads to complete. On rare occasions, a thread may hang and delay the exit unnecessarily. If this parameter is set to True, an additional check is made a few times to see if there are any worker temporary directories still present. If there are none, then it's assumed the worker can safely exit.</td>
</tr>
<tr>
<td>CONN_APP_NAME</td>
<td>String</td>
<td><code>lv-{{realm}}-{{job_id}}</code></td>
<td>A Jinja template used to generate database client connection identifiers. It is rendered with the realm name, job ID and connection ID. See <a href="07-connectors.html#database-client-application-identification">Database Client Application Identification</a>.</td>
</tr>
<tr>
<td>CW_METRICS_JOB</td>
<td>Boolean</td>
<td>False</td>
<td>If True, the worker will generate CloudWatch custom metric data for all jobs. Can be overridden (to enable or disable) at the job level as described <a href="#cloudwatch-metrics">below</a>.</td>
</tr>
<tr>
<td>CW_METRICS_PERIOD</td>
<td>Duration</td>
<td><code>1m</code></td>
<td>Period for generation of CloudWatch custom metric data for the worker itself. There is no point in setting this to anything less than 1 minute.</td>
</tr>
<tr>
<td>CW_METRICS_WORKER</td>
<td>Boolean</td>
<td>False</td>
<td>If True, the worker will generate CloudWatch custom metric data for the worker itself as described <a href="#cloudwatch-metrics">below</a>.</td>
</tr>
<tr>
<td>CW_NAMESPACE</td>
<td>String</td>
<td><code>lava</code></td>
<td>The namespace used for CloudWatch custom metrics generated by the worker.</td>
</tr>
<tr>
<td>DEBUG</td>
<td>Boolean</td>
<td>False</td>
<td>If True, some additional information is placed in the <a href="04-dynamodb-tables.html#the-events-table">events table</a> for failed jobs.</td>
</tr>
<tr>
<td>DISPATCHER</td>
<td>String</td>
<td>--&gt;</td>
<td>Fully qualified name for the lava dispatcher executable. Defaults to <code>/usr/local/bin/lava-dispatcher</code>.</td>
</tr>
<tr>
<td>EVENT_TTL</td>
<td>Duration</td>
<td><code>2d</code></td>
<td>Time to live for records in the DynamoDB <a href="04-dynamodb-tables.html#the-events-table">events table</a>.</td>
</tr>
<tr>
<td>HEARTBEAT_FILE</td>
<td>String</td>
<td><code>.heartbeat</code></td>
<td>File name (relative to <code>TMPDIR</code>) that will be touched once every cycle of the worker heartbeat. This is essentially a keep-alive on <code>TMPDIR</code> so some O/S cleanup process doesn't blow it away due to inactivity. As this is part of the heartbeat process, it is only effective if the worker is running using the <code>-b</code> / <code>--heartbeat</code> option.</td>
</tr>
<tr>
<td>ITERATION_MAX_DELAY</td>
<td>Duration</td>
<td><code>5m</code></td>
<td>Maximum allowed delay when rerunning a failed job.</td>
</tr>
<tr>
<td>ITERATION_MAX_LIMIT</td>
<td>Duration</td>
<td>10</td>
<td>Maximum allowed number of run attempts for a job.</td>
</tr>
<tr>
<td>JOB_LOCAL_TMPDIR</td>
<td>Boolean</td>
<td>True</td>
<td>If True, the <code>TMPDIR</code> environment variable will be set for <a href="06-jobs-job-types.html#job-type-cmd">cmd</a>, <a href="06-jobs-job-types.html#job-type-exe">exe</a> and <a href="06-jobs-job-types.html#job-type-pkg">pkg</a> jobs to point into the private temporary run area for each job. If False, the system default value of <code>TMPDIR</code> is used.</td>
</tr>
<tr>
<td>JUMPSTART_DELAY</td>
<td>Duration</td>
<td><code>15s</code></td>
<td>Delay the initial <a href="05-job-dispatch.html#jump-starting-the-scheduler">scheduler jump-start process</a> to allow the worker to fully initialise.</td>
</tr>
<tr>
<td>LOGLEVEL</td>
<td>String</td>
<td><code>info</code></td>
<td>The default logging level.</td>
</tr>
<tr>
<td>PARAM_CACHE_SIZE</td>
<td>Integer</td>
<td><code>100</code></td>
<td>Size of the cache for SSM parameters. Must be &gt; 0.</td>
</tr>
<tr>
<td>PARAM_CACHE_TTL</td>
<td>Duration</td>
<td><code>2m</code></td>
<td>SSM parameter values are only cached for the specified duration.</td>
</tr>
<tr>
<td>PAYLOAD_DOWNLOADER</td>
<td>String</td>
<td><code>v2</code></td>
<td>Selects either payload downloader version. Allowed values are <code>v1</code> (deprecated) or <code>v2</code>. See <a href="06-jobs-job-types.html#job-payloads">Job Payloads</a> for more information.</td>
</tr>
<tr>
<td>PAYLOAD_SETTLING_TIME</td>
<td>Integer</td>
<td>1</td>
<td>Wait this many seconds before attempting to use a payload downloaded from S3. This helps avoid the occasional <em>text file busy</em> error. If this error is appearing, try setting this to 1 or 2 seconds. (Yes, it's a kludge. Sue me.)</td>
</tr>
<tr>
<td>SES_CONFIGURATION_SET</td>
<td>String</td>
<td>None</td>
<td>SES Configuration Set name for SES email sent by lava.</td>
</tr>
<tr>
<td>SES_FROM</td>
<td>String</td>
<td>None</td>
<td>Source email address for SES email sent by lava.</td>
</tr>
<tr>
<td>SES_REGION</td>
<td>String</td>
<td><code>us-east-1</code></td>
<td>AWS region for the Simple Email Service (SES).</td>
</tr>
<tr>
<td>SQS_MAX_DELAY_MINS</td>
<td>Integer</td>
<td><code>15</code></td>
<td>Maximum allowed delay for an SQS message in minutes. This is an AWS constraint.</td>
</tr>
<tr>
<td>STATE_MAX_TTL</td>
<td>Duration</td>
<td><code>366d</code></td>
<td>The maximum allowed time-to-live duration for an item in the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
<tr>
<td>STATE_TTL</td>
<td>Duration</td>
<td><code>7d</code></td>
<td>The default time-to-live duration for an item in the <a href="04-dynamodb-tables.html#the-state-table">state</a> table.</td>
</tr>
<tr>
<td>STDERR_SIZE</td>
<td>Size</td>
<td><code>1024</code></td>
<td>The number of bytes read from stderr when running jobs to include in the DynamoDB <a href="04-dynamodb-tables.html#the-events-table">events table</a>. The full contents of stderr are saved in S3. If &gt; 0, data is read from the start of the file. If &lt; 0, data is read from the end of the file. The latter is often more useful as that is typically where a fatal error message is found.</td>
</tr>
<tr>
<td>TMPDIR</td>
<td>String</td>
<td><code>/tmp/lava</code></td>
<td>Lava temporary directory for creating private run spaces for jobs. Not to be confused with the <code>TMPDIR</code> environment variable.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-cmd-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-cmd">cmd</a> Jobs<a class="headerlink" href="#configuration-for-cmd-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CMD_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the job.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-dag-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-dag">dag</a> Jobs<a class="headerlink" href="#configuration-for-dag-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>DAG_MAX_WORKERS</td>
<td>Duration</td>
<td>4 * CPU count</td>
<td>Maximum allowed number of worker threads for dag jobs.</td>
</tr>
<tr>
<td>DAG_WORKERS</td>
<td>Duration</td>
<td>CPU count</td>
<td>Default number of worker threads for dag jobs.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-db_from_s3-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-db_from_s3">db_from_s3</a> Jobs<a class="headerlink" href="#configuration-for-db_from_s3-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>PG_COPY_TIMEOUT</td>
<td>Duration</td>
<td><code>30m</code></td>
<td>Timeout for individual client side copy operations for Postgres.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-docker-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-docker">docker</a> Jobs<a class="headerlink" href="#configuration-for-docker-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>DOCKER_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the container.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-exe-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-exe">exe</a> Jobs<a class="headerlink" href="#configuration-for-exe-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EXE_MAX_PAYLOAD_SIZE</td>
<td>Duration</td>
<td><code>10M</code></td>
<td>Maximum payload size.</td>
</tr>
<tr>
<td>EXE_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the job.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-foreach-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-foreach">foreach</a> Jobs<a class="headerlink" href="#configuration-for-foreach-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>FOREACH_LIMIT</td>
<td>Integer</td>
<td>10</td>
<td>The default limit on loop iterations for a <a href="06-jobs-job-types.html#job-type-foreach">foreach</a> job. This can be overridden in the job specification.</td>
</tr>
<tr>
<td>FOREACH_MAX_LIMIT</td>
<td>Integer</td>
<td>25</td>
<td>The maximum limit on loop iterations for a <a href="06-jobs-job-types.html#job-type-foreach">foreach</a> job. This cannot be overridden in the job specification.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-pkg-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-pkg">pkg</a> Jobs<a class="headerlink" href="#configuration-for-pkg-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>PKG_MAX_PAYLOAD_SIZE</td>
<td>Size</td>
<td><code>20M</code></td>
<td>Maximum payload size.</td>
</tr>
<tr>
<td>PKG_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the job.</td>
</tr>
<tr>
<td>PKG_UNPACK_TIMEOUT</td>
<td>Duration</td>
<td><code>30s</code></td>
<td>Timeout for unpacking the job payload after downloading from S3.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-sharepoint-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-sharepoint_get_list">sharepoint</a> Jobs<a class="headerlink" href="#configuration-for-sharepoint-jobs" title="Permanent link">&para;</a></h3>
<p>The <code>SP_LIST_*</code> parameters relate to conversion between SharePoint lists and
columnar data files.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>SP_LIST_DELIMITER</td>
<td>String</td>
<td><code>|</code> (pipe)</td>
<td>Single character field delimiter.</td>
</tr>
<tr>
<td>SP_LIST_DOUBLEQUOTE</td>
<td>Boolean</td>
<td><code>False</code></td>
<td>As for Python csv.writer.</td>
</tr>
<tr>
<td>SP_LIST_ESCAPECHAR</td>
<td>String</td>
<td>None</td>
<td>As for Python csv.writer.</td>
</tr>
<tr>
<td>SP_LIST_QUOTING</td>
<td>String</td>
<td><code>minimal</code></td>
<td>As for csv.writer <code>QUOTE_*</code> parameters (without the QUOTE_ prefix). Default <code>minimal</code> (i.e. <code>QUOTE_MINIMAL</code>).</td>
</tr>
<tr>
<td>SP_LOGGING</td>
<td>Boolean</td>
<td><code>False</code></td>
<td>Enable enhanced logging for the Sharepoint connector.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-sql-sqli-and-sqlv-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-sql">sql</a>, <a href="06-jobs-job-types.html#job-type-sqli">sqli</a> and <a href="06-jobs-job-types.html#job-type-sqlv">sqlv</a> Jobs<a class="headerlink" href="#configuration-for-sql-sqli-and-sqlv-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQL_BATCH_SIZE</td>
<td>Integer</td>
<td><code>1000</code></td>
<td>Number of rows to fetch in one go.</td>
</tr>
<tr>
<td>SQL_DELIMITER</td>
<td>String</td>
<td><code>|</code> (pipe)</td>
<td>Single character field delimiter for data output.</td>
</tr>
<tr>
<td>SQL_DIALECT</td>
<td>String</td>
<td><code>excel</code></td>
<td>As for Python csv.writer.</td>
</tr>
<tr>
<td>SQL_DOUBLEQUOTE</td>
<td>Boolean</td>
<td><code>False</code></td>
<td>As for Python csv.writer.</td>
</tr>
<tr>
<td>SQL_ESCAPECHAR</td>
<td>String</td>
<td>None</td>
<td>As for Python csv.writer.</td>
</tr>
<tr>
<td>SQL_MAX_PAYLOAD_SIZE</td>
<td>Size</td>
<td><code>100k</code></td>
<td>Maximum payload size. (<a href="06-jobs-job-types.html#job-type-sql">sql</a> and <a href="06-jobs-job-types.html#job-type-sqlv">sqlv</a> only.)</td>
</tr>
<tr>
<td>SQL_OUTPUT_SUFFIX</td>
<td>String</td>
<td><code>.out</code></td>
<td>Suffix for output files. (<a href="06-jobs-job-types.html#job-type-sql">sql</a>, <a href="06-jobs-job-types.html#job-type-sqli">sqli</a> only.)</td>
</tr>
<tr>
<td>SQL_QUOTING</td>
<td>String</td>
<td><code>minimal</code></td>
<td>As for csv.writer <code>QUOTE_*</code> parameters (without the QUOTE_ prefix). Default <code>minimal</code> (i.e. <code>QUOTE_MINIMAL</code>).</td>
</tr>
</tbody>
</table>
<p>The following parameters are specific to <a href="06-jobs-job-types.html#job-type-sqlv">sqlc</a> 
jobs:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLV_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the job.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-sqlc-jobs">Configuration for <a href="06-jobs-job-types.html#job-type-sqlc">sqlc</a> Jobs<a class="headerlink" href="#configuration-for-sqlc-jobs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLC_MAX_PAYLOAD_SIZE</td>
<td>Size</td>
<td><code>100k</code></td>
<td>Maximum payload size.</td>
</tr>
<tr>
<td>SQLC_TIMEOUT</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>Run timeout for the job.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-the-aws-connector">Configuration for the <a href="07-connectors.html#connector-type-aws">aws</a> Connector<a class="headerlink" href="#configuration-for-the-aws-connector" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS_ACCESS_KEY_CACHE_SIZE</td>
<td>Integer</td>
<td><code>20</code></td>
<td>Size of the cache for AWS access keys.</td>
</tr>
<tr>
<td>AWS_ACCESS_KEY_CACHE_TTL</td>
<td>Duration</td>
<td><code>10m</code></td>
<td>AWS access keys are cached for the specified duration. This <strong>must</strong> be less than the duration for session credentials and should be significantly less.</td>
</tr>
<tr>
<td>AWS_CONN_DURATION</td>
<td>Duration</td>
<td><code>3h</code></td>
<td>The default session duration for AWS session credentials obtained by assuming an IAM role. This can be overridden in individual <a href="07-connectors.html#connector-type-aws">aws</a> connections.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-the-email-connector">Configuration for the <a href="07-connectors.html#connector-type-email">email</a> Connector<a class="headerlink" href="#configuration-for-the-email-connector" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EMAIL_MAX_ATTACHMENT_SIZE</td>
<td>Size</td>
<td><code>2M</code></td>
<td>Maximum allowed size of any single attachment in bytes.</td>
</tr>
<tr>
<td>EMAIL_MAX_SIZE</td>
<td>Size</td>
<td><code>5M</code></td>
<td>Maximum allowed size of an email message in bytes. This includes the headers, body and attachments.</td>
</tr>
<tr>
<td>EMAIL_MAX_ATTACHMENTS</td>
<td>Integer</td>
<td><code>5</code></td>
<td>Maximum number of attachments per email message. Set to zero to disable attachments entirely.</td>
</tr>
</tbody>
</table>
<h3 id="configuration-for-the-redshift-connector">Configuration for the <a href="07-connectors.html#connector-type-redshift">redshift</a> Connector<a class="headerlink" href="#configuration-for-the-redshift-connector" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RS_PASSWORD_DURATION</td>
<td>Duration</td>
<td><code>15m</code></td>
<td>Password validity period when obtaining temporary IAM credentials for Redshift provisioned clusters using <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/generating-iam-credentials-steps.html">GetClusterCredentials</a>.</td>
</tr>
</tbody>
</table>
<p>Note the same parameter is used for an equivalent purpose for the
<a href="#configuration-for-the-redshift-serverless-connector">redshift-serverless</a> connector.</p>
<h3 id="configuration-for-the-redshift-serverless-connector">Configuration for the <a href="07-connectors.html#connector-type-redshift-serverless">redshift-serverless</a> Connector<a class="headerlink" href="#configuration-for-the-redshift-serverless-connector" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RS_PASSWORD_DURATION</td>
<td>Duration</td>
<td><code>15m</code></td>
<td>Password validity period when obtaining temporary IAM credentials for Redshift Serverless clusters using <a href="https://docs.aws.amazon.com/redshift-serverless/latest/APIReference/API_GetCredentials.html">GetCredentials</a>.</td>
</tr>
</tbody>
</table>
<p>Note the same parameter is used for an equivalent purpose for the
<a href="#configuration-for-the-redshift-connector">redshift</a> connector.</p>
<h2 id="lambda-function-configuration">Lambda Function Configuration<a class="headerlink" href="#lambda-function-configuration" title="Permanent link">&para;</a></h2>
<p>The lambda functions use the same configuration mechanisms as described above
for the lava worker with the exception that they do not read any configuration
from the <a href="04-dynamodb-tables.html#the-realms-table">realms table</a>. </p>
<p>Setting configuration values to non-default values must be done by setting the
corresponding <code>LAVA_*</code> environment variable on the lambda function itself.</p>
<h3 id="configuration-for-s3trigger">Configuration for <a href="05-job-dispatch.html#dispatching-jobs-from-s3-events">s3trigger</a><a class="headerlink" href="#configuration-for-s3trigger" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>S3TRIGGER_CACHE_TTL</td>
<td>Duration</td>
<td><code>60s</code></td>
<td>The <a href="05-job-dispatch.html#dispatching-jobs-from-s3-events">s3trigger lambda</a> will cache lookup results on the <a href="04-dynamodb-tables.html#the-s3triggers-table">s3triggers</a> and <a href="04-dynamodb-tables.html#the-jobs-table">jobs</a> tables for the specified duration. A zero duration disables caching.</td>
</tr>
<tr>
<td>S3TRIGGER_DEDUP_CACHE_SIZE</td>
<td>Integer</td>
<td><code>0</code></td>
<td>The number of entries in the <a href="05-job-dispatch.html#s3-event-deduplication">s3trigger deduplication</a> cache. Setting this to <code>0</code> disables deduplication.</td>
</tr>
<tr>
<td>S3TRIGGER_DEDUP_TTL</td>
<td>Duration</td>
<td><code>30s</code></td>
<td>The time to live for entries in the <a href="05-job-dispatch.html#s3-event-deduplication">s3trigger deduplication</a> cache.</td>
</tr>
<tr>
<td>SQS_MAX_DELAY_MINS</td>
<td>Integer</td>
<td><code>15</code></td>
<td>Maximum allowed delay for an SQS message in minutes. This is an AWS constraint.</td>
</tr>
</tbody>
</table>
<h2 id="instrumentation-and-monitoring-of-lava">Instrumentation and Monitoring of Lava<a class="headerlink" href="#instrumentation-and-monitoring-of-lava" title="Permanent link">&para;</a></h2>
<p>Lava has the following instrumentation and monitoring facilities:</p>
<ul>
<li>
<p>Lava worker and dispatcher <a href="#logging">logging</a>.</p>
</li>
<li>
<p>Logging to AWS CloudWatch logs for the lambda functions.</p>
</li>
<li>
<p><a href="#cloudwatch-metrics">AWS CloudWatch custom metrics</a> for
    lava jobs and internal worker behaviour.</p>
</li>
<li>
<p>Predefined <a href="#cloudwatch-alarms">AWS CloudWatch alarms</a>.</p>
</li>
</ul>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<p>Both the worker and dispatcher accept a range of options to control logging.</p>
<p>Capabilities include:</p>
<ul>
<li>
<p>Generating a heartbeat message at a defined interval (worker only).</p>
</li>
<li>
<p>Setting logging level anywhere between <code>debug</code> and <code>critical</code>.</p>
</li>
<li>
<p>Logging to stderr, a file or designated syslog facility.</p>
</li>
<li>
<p>Tagging log entries so they can be filtered from other unrelated logs.</p>
</li>
<li>
<p>Logging in text or JSON format.</p>
</li>
</ul>
<p>For more information:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1">lava-worker<span class="w"> </span>--help
</span><span id="__span-48-2">lava-dispatcher<span class="w"> </span>--help
</span></code></pre></div>
<p>The standard production configuration for the worker when running on the
<a href="#the-lava-ec2-ami">lava AMI</a> is:</p>
<ul>
<li>
<p>Set the logging level to <code>info</code></p>
</li>
<li>
<p>Generate a heartbeat every 60 seconds. This is also used to trigger
    heartbeat</p>
</li>
<li>
<p>Log in JSON format to the <code>local0</code> syslog facility which is directed to the
    file <code>/var/log/lava</code> on the worker machine. (The messages are also included
    in the general system log in the file <code>/var/log/messages</code>.)</p>
</li>
<li>
<p>The <code>/var/log/lava</code> log file is automatically replicated to the CloudWatch
    log group <code>/var/log/lava/&lt;REALM&gt;</code>.</p>
</li>
</ul>
<p>A typical message (although on a single line) appears thus:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-49-1"><span class="p">{</span>
</span><span id="__span-49-2"><span class="w">  </span><span class="nt">&quot;event_source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-worker&quot;</span><span class="p">,</span>
</span><span id="__span-49-3"><span class="w">  </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="p">,</span>
</span><span id="__span-49-4"><span class="w">  </span><span class="nt">&quot;worker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;core&quot;</span><span class="p">,</span>
</span><span id="__span-49-5"><span class="w">  </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my-host&quot;</span><span class="p">,</span>
</span><span id="__span-49-6"><span class="w">  </span><span class="nt">&quot;tag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-worker&quot;</span><span class="p">,</span>
</span><span id="__span-49-7"><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-05-11 15:04:36&quot;</span><span class="p">,</span>
</span><span id="__span-49-8"><span class="w">  </span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
</span><span id="__span-49-9"><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Job cmd/hello-world (2ce3ac8e-0fc2-41f1-b908-998608a0b24b): Complete&quot;</span><span class="p">,</span>
</span><span id="__span-49-10"><span class="w">  </span><span class="nt">&quot;thread&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;worker-00&quot;</span><span class="p">,</span>
</span><span id="__span-49-11"><span class="w">  </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">37273</span><span class="p">,</span>
</span><span id="__span-49-12"><span class="w">  </span><span class="nt">&quot;event_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;job&quot;</span><span class="p">,</span>
</span><span id="__span-49-13"><span class="w">  </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test/cmd/hello-world&quot;</span><span class="p">,</span>
</span><span id="__span-49-14"><span class="w">  </span><span class="nt">&quot;run_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2ce3ac8e-0fc2-41f1-b908-998608a0b24b&quot;</span>
</span><span id="__span-49-15"><span class="p">}</span>
</span></code></pre></div>
<p>The following search predicate would find this record in CloudWatch logs:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1">{ $.realm=dev &amp;&amp; $.job=cmd/hello-world &amp;&amp; $.run_id=2ce3ac8e-0fc2-41f1-b908-998608a0b24b }
</span></code></pre></div>
<p>The log group can also be queried using CloudWatch Log Insights. The
(approximately) equivalent Insights query is:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1">fields @timestamp, @message, @logStream, @log
</span><span id="__span-51-2">| filter realm = &quot;dev&quot; and job_id=&quot;cmd/hello-world&quot; and run_id=&quot;2ce3ac8e-0fc2-41f1-b908-998608a0b24b&quot;
</span><span id="__span-51-3">| sort @timestamp desc
</span></code></pre></div>
<p>As is usual for Lambda functions, the lava lambdas also log directly to
CloudWatch.</p>
<h3 id="heartbeats">Heartbeats<a class="headerlink" href="#heartbeats" title="Permanent link">&para;</a></h3>
<p>When used with the worker startup script provided for use in production
deployments, the lava worker emits a heartbeat message to syslog every 60
seconds. These records propagate to the CloudWatch log group <code>/var/log/messages</code>.
A log metric filter on this group is used as the basis of a CloudWatch Metric
which underpins an alarm in the event of loss of heartbeat. This is all configured
via the <a href="#building-the-cloudformation-templates">worker CloudFormation stack</a>.</p>
<p>As of v7.1.0 (Pichincha), the heartbeat message also contains additional worker
health information. A typical heartbeat message (although on a single line)
appears thus:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-52-1"><span class="p">{</span>
</span><span id="__span-52-2"><span class="w">  </span><span class="nt">&quot;event_source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-worker&quot;</span><span class="p">,</span>
</span><span id="__span-52-3"><span class="w">  </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="p">,</span>
</span><span id="__span-52-4"><span class="w">  </span><span class="nt">&quot;worker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;core&quot;</span><span class="p">,</span>
</span><span id="__span-52-5"><span class="w">  </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my-host&quot;</span><span class="p">,</span>
</span><span id="__span-52-6"><span class="w">  </span><span class="nt">&quot;tag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-worker&quot;</span><span class="p">,</span>
</span><span id="__span-52-7"><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-05-11 18:09:23&quot;</span><span class="p">,</span>
</span><span id="__span-52-8"><span class="w">  </span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
</span><span id="__span-52-9"><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;heartbeat realm=dev worker=core&quot;</span><span class="p">,</span>
</span><span id="__span-52-10"><span class="w">  </span><span class="nt">&quot;thread&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;heartbeat&quot;</span><span class="p">,</span>
</span><span id="__span-52-11"><span class="w">  </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">37273</span><span class="p">,</span>
</span><span id="__span-52-12"><span class="w">  </span><span class="nt">&quot;event_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;heartbeat&quot;</span><span class="p">,</span>
</span><span id="__span-52-13"><span class="w">  </span><span class="nt">&quot;sqs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-14"><span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-52-15"><span class="w">    </span><span class="nt">&quot;notvisible&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-52-16"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-52-17"><span class="w">  </span><span class="nt">&quot;internal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-18"><span class="w">    </span><span class="nt">&quot;qlen&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-52-19"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-52-20"><span class="w">  </span><span class="nt">&quot;threads&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-21"><span class="w">    </span><span class="nt">&quot;event&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span><span class="p">,</span>
</span><span id="__span-52-22"><span class="w">    </span><span class="nt">&quot;worker-00&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span><span class="p">,</span>
</span><span id="__span-52-23"><span class="w">    </span><span class="nt">&quot;worker-01&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span><span class="p">,</span>
</span><span id="__span-52-24"><span class="w">    </span><span class="nt">&quot;heartbeat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span><span class="p">,</span>
</span><span id="__span-52-25"><span class="w">    </span><span class="nt">&quot;metrics&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span>
</span><span id="__span-52-26"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-52-27"><span class="p">}</span>
</span></code></pre></div>
<p>The various threads perform the following functions:</p>
<table>
<thead>
<tr>
<th>Thread</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>event</td>
<td>Send events to the DynamoDB <a href="04-dynamodb-tables.html#the-events-table">events table</a>.</td>
</tr>
<tr>
<td>heartbeat</td>
<td>Emit heartbeat messages.</td>
</tr>
<tr>
<td>metrics</td>
<td>Send metric data to CloudWatch.</td>
</tr>
<tr>
<td>worker-*</td>
<td>Run lava jobs.</td>
</tr>
</tbody>
</table>
<h3 id="cloudwatch-metrics">CloudWatch Metrics<a class="headerlink" href="#cloudwatch-metrics" title="Permanent link">&para;</a></h3>
<p>The lava worker can generate CloudWatch custom metrics for individual jobs and
for the worker itself.</p>
<h4 id="job-metrics">Job Metrics<a class="headerlink" href="#job-metrics" title="Permanent link">&para;</a></h4>
<p>Job metrics can be enabled at the realm level or at the individual job level.
The following process is used to determine if metric data will be produced:</p>
<ol>
<li>
<p>If the <code>cw_metrics</code> field is set in the
    <a href="04-dynamodb-tables.html#the-jobs-table">job specification</a>, that value is used to
    either enable or disable metric data generation.</p>
</li>
<li>
<p>Otherwise, the value specified at the
    <a href="#lava-worker-configuration">worker or realm level</a> via the 
    <a href="#general-configuration-parameters">CW_METRICS_JOB parameter</a>
    is used.</p>
</li>
</ol>
<p>If enabled, the following job metrics are produced for each job:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Dimensions</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>JobFailed</td>
<td>Realm, Job</td>
<td><code>0</code> if the job succeeded and <code>1</code> if it failed.</td>
</tr>
<tr>
<td>RunDelay</td>
<td>Realm, Worker</td>
<td>The time in seconds between job dispatch and job start. This should normally be under 10 seconds. Values above this may indicate the worker is overloaded.</td>
</tr>
<tr>
<td>RunTime</td>
<td>Realm, Job</td>
<td>The runtime in seconds of the job from when it started to the completion of any post-job actions.</td>
</tr>
</tbody>
</table>
<h4 id="worker-metrics">Worker Metrics<a class="headerlink" href="#worker-metrics" title="Permanent link">&para;</a></h4>
<p>Worker metrics can be enabled at the 
<a href="#lava-worker-configuration">worker or realm level</a> via the 
<a href="#general-configuration-parameters">CW_METRICS_WORKER parameter</a>.</p>
<p>If enabled, the following worker metrics are produced:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Dimensions</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MaxRss</td>
<td>Realm, Worker, Instance</td>
<td>The maximum resident set size for the main worker process. See <a href="http://man7.org/linux/man-pages/man2/getrusage.2.html">getrusage(2)</a> for more information.</td>
</tr>
<tr>
<td>PercentDiskUsed</td>
<td>Realm, Worker, Instance</td>
<td>This is a deprecated name for <code>PercentTmpDiskUsed</code>. It will be removed in a future release.</td>
</tr>
<tr>
<td>PercentDockerDiskUsed</td>
<td>Realm, Worker, Instance</td>
<td>The percentage of disk space used for the docker volume on the worker, if present.</td>
</tr>
<tr>
<td>PercentMemUsed</td>
<td>Realm, Worker, Instance</td>
<td>The percentage of memory used on the worker measured as the total physical memory minus the memory that can be given instantly to processes without the system going into swap. See <a href="https://psutil.readthedocs.io/en/latest/">psutil.virtual_memory()</a>.</td>
</tr>
<tr>
<td>PercentSwapUsed</td>
<td>Realm, Worker, Instance</td>
<td>The percentage of swap memory used on the worker. See <a href="https://psutil.readthedocs.io/en/latest/">psutil.virtual_memory()</a>.</td>
</tr>
<tr>
<td>PercentTmpDiskUsed</td>
<td>Realm, Worker, Instance</td>
<td>The percentage of disk space used for the lava temporary area on the worker.</td>
</tr>
<tr>
<td>WorkerThreadsAlive</td>
<td>Realm, Worker, Instance</td>
<td>The number of job worker threads that are alive. The worker thread pool size is dependent on the configuration of a particular worker daemon. This is typically controlled in the <a href="04-dynamodb-tables.html#the-realms-table">realms table</a>.</td>
</tr>
<tr>
<td>WorkerThreadsDead</td>
<td>Realm, Worker, Instance</td>
<td>The number of job worker threads that have died. If not enough worker threads are active, job delays can increase.</td>
</tr>
</tbody>
</table>
<h3 id="cloudwatch-alarms">CloudWatch Alarms<a class="headerlink" href="#cloudwatch-alarms" title="Permanent link">&para;</a></h3>
<p>The CloudFormation worker template optionally creates the following CloudWatch
alarms:</p>
<ul>
<li>
<p>A heartbeat alarm if the worker heartbeat message is not detected in the
    <code>/var/log/messages</code> CloudWatch log group for 5 minutes. This relies on the
    worker being configured to generate a heartbeat message every 60 seconds and
    the node being configured to replicate syslog messages to CloudWatch.</p>
</li>
<li>
<p>An SQS queue depth alarm if the <code>ApproximateNumberOfMessagesVisible</code> metric
    exceeds a value specified as a CloudFormation stack parameter. This alarm
    can indicate a dead or overloaded worker.</p>
</li>
</ul>
<p>The target for the alarms is an SNS topic specified as a CloudFormation stack
parameter.</p>
<h3 id="getting-internal-worker-state-information">Getting Internal Worker State Information<a class="headerlink" href="#getting-internal-worker-state-information" title="Permanent link">&para;</a></h3>
<p>It is possible to get the worker to reveal some of its internal state by sending
it a SIGUSR1 (signal number 30). The information is written to the logger.
Typically, this is sent to <strong>syslog</strong>.</p>
<h2 id="maintaining-dynamodb-table-entries">Maintaining DynamoDB Table Entries<a class="headerlink" href="#maintaining-dynamodb-table-entries" title="Permanent link">&para;</a></h2>
<p>Lava comes with a number of mechanisms to assist with maintaining the health of
the entries in the <a href="04-dynamodb-tables.html#dynamodb-tables">DynamoDB tables</a>. These include:</p>
<ul>
<li>
<p>The <strong><a href="11-lava-job-framework.html#the-lava-job-framework">lava job framework</a></strong> which provides a
    standardised template for creating, configuring and deploying lava jobs and
    associated components. It also provides support for automatic generation of
    checksums on table entries and
    <a href="11-lava-job-framework.html#configuration-drift-detection">configuration drift detection</a>.</p>
</li>
<li>
<p><strong>Deep Schema validation</strong> via the <a href="16-commands-utilities.html#lava-schema-utility">lava-schema</a>
    utility.</p>
</li>
<li>
<p><strong>Bad practice detection</strong> via the <a href="16-commands-utilities.html#lava-check-utility">lava-check</a> utility.</p>
</li>
<li>
<p><strong>Checksum generation and validation</strong> for DynamoDB table entries via the
    <a href="16-commands-utilities.html#lava-checksum-utility">lava-checksum</a> utility and the
    <a href="11-lava-job-framework.html#the-lava-job-framework">lava job framework</a>.</p>
</li>
</ul>
<h2 id="backing-up-lava-configuration">Backing Up Lava Configuration<a class="headerlink" href="#backing-up-lava-configuration" title="Permanent link">&para;</a></h2>
<p>When the lava <a href="04-dynamodb-tables.html#dynamodb-tables">DynamoDB tables</a> are created using the realm
CloudFormation template, point-in-time recovery is configured for the main
configuration tables. DynamoDB maintains continuous backups of the tables for
the last 35 days.</p>
<p>Lava also comes with two additional utilities to facilitate bulk extraction and
backup of data from the lava tables.</p>
<ul>
<li>
<p><a href="16-commands-utilities.html#lava-dump-utility">lava-dump</a> performs a bulk extract of data from a
    single table to a local directory. It can extract all entries with keys that
    match any of a list of GLOB style patterns. By default, all entries are
    extracted.</p>
</li>
<li>
<p><a href="16-commands-utilities.html#lava-backup-utility">lava-backup</a> performs a complete extract of all of
    the configuration tables for a given realm and stores the result in a zip
    file, either locally or in AWS S3. It can be run as a lava
    <a href="06-jobs-job-types.html#job-type-cmd">cmd</a> job if required.</p>
</li>
</ul>
<h2 id="lava-worker-management">Lava Worker Management<a class="headerlink" href="#lava-worker-management" title="Permanent link">&para;</a></h2>
<h3 id="lava-worker-auto-scaling">Lava Worker Auto Scaling<a class="headerlink" href="#lava-worker-auto-scaling" title="Permanent link">&para;</a></h3>
<p>Lava workers created using the provided worker CloudFormation template sit in an
auto scaling group with a set of supporting resources to assist with horizontal
capacity scaling and controlled worker node termination.</p>
<p>The auto scaling architecture is shown below.</p>
<p><img alt="" src="img/lava-worker-scaling.svg" /></p>
<p>The key components are:</p>
<ol>
<li>
<p>The EC2 auto scaling group itself, named <code>lava-&lt;REALM&gt;-&lt;WORKER&gt;</code>.  <br />
    The <em>minimum</em>, <em>preferred</em> and <em>maximum</em> instance counts are specified as
    parameters in the worker CloudFormation stack. Workers that act as schedule
    based dispatchers <strong>must</strong> have all values set to 1. Other workers can have
    whatever is needed noting that the auto scaling can create that many
    instances, so be reasonable. Also note that if auto scaling is enabled, the
    minimum should be 1 or the auto scaler will scale down to 0 and it will
    never scale up.</p>
</li>
<li>
<p>A lambda function, <code>lava-&lt;REALM&gt;-metrics</code>.  <br />
    This is triggered by an Amazon EventBridge schedule every minute to generate
    a metric that is the worker <em>SQS job queue depth per in-service instance</em> in
    the auto scaling group. This metric is used to drive the auto scaling
    process using a <em>TargetTracking</em> policy.  This is referred to as the
    <strong>worker backlog</strong>.</p>
</li>
<li>
<p>An EC2 auto scaling <em>TargetTracking</em> policy.  <br />
    This is controlled by the worker backlog metric to cause the worker fleet to
    scale out or in as appropriate. The target value for auto scaling purposes
    is specified in the worker CloudFormation stack. See <a href="#setting-the-auto-scaling-target-value">Setting the Auto
    Scaling Target
    Value</a>.</p>
</li>
<li>
<p>An EC2 auto scaling lifecycle hook for terminating nodes.  <br />
    This will send an appropriate message to the Amazon EventBridge default bus.</p>
</li>
<li>
<p>An AWS EventBridge rule, <code>lava-&lt;REALM&gt;-&lt;WORKER&gt;-terminating</code>.  <br />
    This detects the lifecycle hook message and triggers the <code>lava-&lt;REALM&gt;-stop</code>
    lambda function, providing it with the lifecycle event details.</p>
</li>
<li>
<p>The <code>lava-&lt;REALM&gt;-stop</code> lambda function.  <br />
    This uses AWS Systems Manager <code>RunCommand</code> to run the
    <a href="16-commands-utilities.html#lava-stop-utility">lava-stop</a>
    utility on the instance. This will do a controlled shutdown of the lava
    worker daemons and wait for them to complete. It also inhibits further
    scheduled job dispatches during the shutdown process. Auto scaling
    lifecycle hook heartbeat messages will be issued periodically until the 
    daemons stop, at which point a lifecycle completion message will be sent.
    If the daemons fail to stop in a reasonable period of time, they are killed.</p>
</li>
</ol>
<h4 id="setting-the-auto-scaling-target-value">Setting the Auto Scaling Target Value<a class="headerlink" href="#setting-the-auto-scaling-target-value" title="Permanent link">&para;</a></h4>
<p>The lava worker EC2 auto scaling process uses a <em>TargetTracking</em> policy based
on a custom metric referred to as the <strong>worker backlog</strong>. This is defined as
the <code>ApproximateNumberOfMessagesVisible</code> for the worker job queue divided by the
number of instances in the <code>InService</code> state in the work auto scaling group.</p>
<p>In short, the <strong>worker backlog</strong> is the number of jobs waiting per worker
instance.</p>
<p>This follows the pattern
<a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-using-sqs-queue.html">recommended by AWS</a>.</p>
<p>The metric is calculated every minute by the <code>lava-&lt;REALM&gt;-metrics</code> lambda function.</p>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Namespace</th>
<th>Dimensions</th>
<th>Unit</th>
</tr>
</thead>
<tbody>
<tr>
<td>WorkerBacklog</td>
<td>Lava</td>
<td>Realm, Worker</td>
<td>None</td>
</tr>
</tbody>
</table>
<p>The crucial aspect of the auto scaling process is the selection of the target
value for the <code>WorkerBacklog</code> metric.</p>
<h4 id="method-1-aws-recommended-approach">Method 1 - AWS Recommended Approach<a class="headerlink" href="#method-1-aws-recommended-approach" title="Permanent link">&para;</a></h4>
<p>To do this, AWS recommends the following <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-using-sqs-queue.html#scale-sqs-queue-custom-metric">process</a>:</p>
<ol>
<li>
<p>Estimate the acceptable latency for a job to run.</p>
</li>
<li>
<p>Estimated the average processing time (i.e. average job run time).</p>
</li>
<li>
<p>Divide the latency by the average run time to get the target value.</p>
</li>
</ol>
<p>For example, if the acceptable latency is 10 minutes (600 seconds) and the
average job run time is 20 seconds, the target value would be 30. So if the
queue gets 300 messages, it will start 10 instances. This may, or may not, be what
you want to happen.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The number of worker instances is always capped by the maximum instance
count of the auto scaling group, as specified in the lava worker
CloudFormation stack.</p>
</div>
<h4 id="method-2-guess">Method 2 - Guess<a class="headerlink" href="#method-2-guess" title="Permanent link">&para;</a></h4>
<p>The trouble with method 1 is that lava jobs can vary widely in run time, from
seconds to hours. So the average processing time may not be a reliable data
point.</p>
<p>An alternative approach is to disable auto scaling initially (using parameters
in the worker CloudFormation stack) and monitor the SQS queue depth for a period
of time. Then take an educated guess.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's probably better to set the target too high rather than too low,
initially.</p>
</div>
<h3 id="stopping-the-worker-daemon">Stopping the Worker Daemon<a class="headerlink" href="#stopping-the-worker-daemon" title="Permanent link">&para;</a></h3>
<p>As of version 5.1.0 (Tungurahua), the preferred mechanism to stop the worker
daemon is to send it one of the following signals to initiate a controlled
shutdown:</p>
<ul>
<li>SIGHUP (signal number 1)</li>
<li>SIGINT (signal number 2)</li>
</ul>
<p>The worker will complete any in-flight jobs before terminating.</p>
<p>A second signal will cause a hard shutdown, causing in-flight jobs to be
terminated and, possibly, resubmitted by SQS once the queue visibility timeout
expires.</p>
<h3 id="aws-systems-manager-support">AWS Systems Manager Support<a class="headerlink" href="#aws-systems-manager-support" title="Permanent link">&para;</a></h3>
<p>As of lava version 6.2.0 (Reventador), a number AWS Systems Manager command
documents are provided to assist with performing operations on EC2 based worker
nodes. These are deployed as part of the
<a href="#building-the-cloudformation-templates">lava-common.cfn.json</a> CloudFormation stack.</p>
<h4 id="lava-rebootworkerinstance">lava-RebootWorkerInstance<a class="headerlink" href="#lava-rebootworkerinstance" title="Permanent link">&para;</a></h4>
<p>This command document performs the following steps:</p>
<ol>
<li>
<p>Perform a yum security update.</p>
</li>
<li>
<p>Stop any further scheduled dispatches from the instance.</p>
</li>
<li>
<p>Perform a controlled stop of any lava worker daemons.</p>
</li>
<li>
<p>Reboot the instance.</p>
</li>
</ol>
<p>When the instance reboots, the dispatch blockage will be removed and the worker
daemons will be restarted.</p>
<h4 id="lava-securityupdate">lava-SecurityUpdate<a class="headerlink" href="#lava-securityupdate" title="Permanent link">&para;</a></h4>
<p>This command document is a more sophisticated version of
<a href="#lava-rebootworkerinstance">lava-RebootWorkerInstance</a> designed specifically to
perform yum security updates. It is less disruptive in that it will not reboot
a worker instance unless it is necessary.</p>
<p>It performs the following steps:</p>
<ol>
<li>
<p>Check if the instance has been up for at least a specified period of time.</p>
</li>
<li>
<p>Check if any security updates are pending. If not, exit.</p>
</li>
<li>
<p>Apply the security updates with <code>yum update --security</code>.</p>
</li>
<li>
<p>Check if a reboot is required. If not, exit.</p>
</li>
<li>
<p>Signal the worker daemons to stop.</p>
</li>
<li>
<p>Wait a specified period of time for the worker daemons to finish any
    in-flight jobs and stop.</p>
</li>
<li>
<p>Kill any worker daemons still running.</p>
</li>
<li>
<p>Reboot the instance.</p>
</li>
</ol>
<p>The command document accepts the following parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ExecutionTimeout</td>
<td><code>3600</code></td>
<td>Execution timeout in seconds. The <code>ExecutionTimeout</code> must exceed the <code>Wait</code> duration by enough to allow the patching activity and a reboot.</td>
</tr>
<tr>
<td>LogLevel</td>
<td><code>info</code></td>
<td>Logging level. Allowed values are <code>debug</code>, <code>info</code>, <code>warning</code>.</td>
</tr>
<tr>
<td>MinUpDays</td>
<td><code>0</code></td>
<td>Skip the update process if the EC2 instance hasn't been up for this many days.</td>
</tr>
<tr>
<td>Signal</td>
<td><code>SIGHUP</code></td>
<td>Signal the worker to stop (if necessary) with the specified signal. Allowed values are <code>SIGHUP</code> and <code>SIGKILL</code>. See <a href="#stopping-the-worker-daemon">Stopping the Worker Daemon</a>.</td>
</tr>
<tr>
<td>Wait</td>
<td><code>15m</code></td>
<td>Wait for the specified duration for lava workers to stop voluntarily before killing them.</td>
</tr>
</tbody>
</table>
<p>The command document sends status messages to Amazon EventBridge as part of the
process. These can be captured using standard EventBridge mechanisms to send
notifications to system operators or trigger other automated action, as required.
The messages look like this:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-53-1"><span class="p">{</span>
</span><span id="__span-53-2"><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
</span><span id="__span-53-3"><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1ce8e44-dada-d265-2b9e-beed76ab493b&quot;</span><span class="p">,</span>
</span><span id="__span-53-4"><span class="w">  </span><span class="nt">&quot;detail-type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lava Worker Instance Patching Notification&quot;</span><span class="p">,</span>
</span><span id="__span-53-5"><span class="w">  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava&quot;</span><span class="p">,</span>
</span><span id="__span-53-6"><span class="w">  </span><span class="nt">&quot;account&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789123&quot;</span><span class="p">,</span>
</span><span id="__span-53-7"><span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-05-20T08:16:36Z&quot;</span><span class="p">,</span>
</span><span id="__span-53-8"><span class="w">  </span><span class="nt">&quot;region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span><span class="p">,</span>
</span><span id="__span-53-9"><span class="w">  </span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-53-10"><span class="w">  </span><span class="nt">&quot;detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-11"><span class="w">    </span><span class="nt">&quot;instance-id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;i-082cafe1b7811a47a&quot;</span><span class="p">,</span>
</span><span id="__span-53-12"><span class="w">    </span><span class="nt">&quot;instance-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-dev0-core&quot;</span><span class="p">,</span>
</span><span id="__span-53-13"><span class="w">    </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Rebooting after security patching&quot;</span>
</span><span id="__span-53-14"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-53-15"><span class="p">}</span>
</span></code></pre></div>
<div class="language-json highlight"><pre><span></span><code><span id="__span-54-1"><span class="p">{</span>
</span><span id="__span-54-2"><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
</span><span id="__span-54-3"><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;79d96f65-1be1-50b4-fd4c-d0ae39981eb7&quot;</span><span class="p">,</span>
</span><span id="__span-54-4"><span class="w">  </span><span class="nt">&quot;detail-type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lava Worker Instance Patching Notification&quot;</span><span class="p">,</span>
</span><span id="__span-54-5"><span class="w">  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava&quot;</span><span class="p">,</span>
</span><span id="__span-54-6"><span class="w">  </span><span class="nt">&quot;account&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789123&quot;</span><span class="p">,</span>
</span><span id="__span-54-7"><span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-05-20T08:18:00Z&quot;</span><span class="p">,</span>
</span><span id="__span-54-8"><span class="w">  </span><span class="nt">&quot;region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span><span class="p">,</span>
</span><span id="__span-54-9"><span class="w">  </span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-54-10"><span class="w">  </span><span class="nt">&quot;detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-11"><span class="w">    </span><span class="nt">&quot;instance-id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;i-082cafe1b7811a47a&quot;</span><span class="p">,</span>
</span><span id="__span-54-12"><span class="w">    </span><span class="nt">&quot;instance-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava-dev0-core&quot;</span><span class="p">,</span>
</span><span id="__span-54-13"><span class="w">    </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Reboot complete&quot;</span>
</span><span id="__span-54-14"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-15"><span class="p">}</span>
</span></code></pre></div>
<h4 id="lava-stopworkerdaemons">lava-StopWorkerDaemons<a class="headerlink" href="#lava-stopworkerdaemons" title="Permanent link">&para;</a></h4>
<p>This command document performs the following steps:</p>
<ol>
<li>
<p>Optionally, stop any further scheduled dispatches from the instance.</p>
</li>
<li>
<p>Perform a controlled stop of any lava worker daemons.</p>
</li>
</ol>
<p>The instance is not rebooted. Further action (e.g. to restart lava worker
daemons and re-enable dispatches) requires operator intervention.</p>
<h3 id="security-patching-of-lava-ec2-workers">Security Patching of Lava EC2 Workers<a class="headerlink" href="#security-patching-of-lava-ec2-workers" title="Permanent link">&para;</a></h3>
<p>The <a href="#lava-securityupdate">lava-SecurityUpdate</a> SSM command document provides a
convenient mechanism to perform controlled security updates on EC2 based
lava workers.</p>
<p>This command document can be scheduled by lava itself via a standard job. The
following example shows how this can be done for a given target realm (which
can be different from the realm initiating the command).</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-55-1"><span class="p">{</span>
</span><span id="__span-55-2"><span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Security patching for lava nodes&quot;</span><span class="p">,</span>
</span><span id="__span-55-3"><span class="w">  </span><span class="nt">&quot;dispatcher&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Sydney&quot;</span><span class="p">,</span>
</span><span id="__span-55-4"><span class="w">  </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-55-5"><span class="w">  </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;lava/admin/secupdate/&lt;REALM&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-55-6"><span class="w">  </span><span class="nt">&quot;owner&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Deus ex machina&quot;</span><span class="p">,</span>
</span><span id="__span-55-7"><span class="w">  </span><span class="nt">&quot;parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-8"><span class="w">    </span><span class="nt">&quot;vars&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-9"><span class="w">      </span><span class="nt">&quot;realm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="p">,</span>
</span><span id="__span-55-10"><span class="w">      </span><span class="nt">&quot;up_days&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
</span><span id="__span-55-11"><span class="w">      </span><span class="nt">&quot;wait_mins&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span>
</span><span id="__span-55-12"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-13"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-55-14"><span class="w">  </span><span class="nt">&quot;payload&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws ssm send-command --document-name \&quot;lava-SecurityUpdate\&quot; --targets &#39;[{\&quot;Key\&quot;:\&quot;tag:LavaRealm\&quot;,\&quot;Values\&quot;:[\&quot;{{vars.realm}}\&quot;]}]&#39; --parameters &#39;{\&quot;Wait\&quot;:[\&quot;{{vars.wait_mins}}m\&quot;],\&quot;MinUpDays\&quot;:[\&quot;{{vars.up_days}}\&quot;],\&quot;ExecutionTimeout\&quot;:[\&quot;{{(vars.wait_mins+15)*60}}\&quot;]}&#39; --cloud-watch-output-config &#39;{\&quot;CloudWatchOutputEnabled\&quot;:true,\&quot;CloudWatchLogGroupName\&quot;:\&quot;lava\&quot;}&#39;&quot;</span><span class="p">,</span>
</span><span id="__span-55-15"><span class="w">  </span><span class="nt">&quot;schedule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0 19 * * Sat,Sun&quot;</span><span class="p">,</span>
</span><span id="__span-55-16"><span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span>
</span><span id="__span-55-17"><span class="w">  </span><span class="nt">&quot;worker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;core&quot;</span>
</span><span id="__span-55-18"><span class="p">}</span>
</span></code></pre></div>
<p>The IAM setup for this to work requires that the lava worker can run
<code>ssm:SendCommand</code> for</p>
<ul>
<li>The <code>lava-*</code> command documents; and</li>
<li>For all EC2 instances with specified values of the <code>LavaRealm</code> tag.</li>
</ul>
<p>The IAM policy for the worker will include elements like these:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-56-1"><span class="p">{</span>
</span><span id="__span-56-2"><span class="w">  </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RunLavaCommandDocs&quot;</span><span class="p">,</span>
</span><span id="__span-56-3"><span class="w">  </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ssm:SendCommand&quot;</span><span class="p">,</span>
</span><span id="__span-56-4"><span class="w">  </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span id="__span-56-5"><span class="w">  </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-56-6"><span class="w">    </span><span class="s2">&quot;arn:aws:ssm:ap-southeast-2:123456789123:document/lava-*&quot;</span>
</span><span id="__span-56-7"><span class="w">  </span><span class="p">]</span>
</span><span id="__span-56-8"><span class="p">},</span>
</span><span id="__span-56-9"><span class="p">{</span>
</span><span id="__span-56-10"><span class="w">  </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RunLavaCommandInstances&quot;</span><span class="p">,</span>
</span><span id="__span-56-11"><span class="w">  </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ssm:SendCommand&quot;</span><span class="p">,</span>
</span><span id="__span-56-12"><span class="w">  </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-13"><span class="w">    </span><span class="nt">&quot;StringLike&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-14"><span class="w">      </span><span class="nt">&quot;ssm:resourceTag/LavaRealm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
</span><span id="__span-56-15"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-16"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-56-17"><span class="w">  </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span id="__span-56-18"><span class="w">  </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-56-19"><span class="w">    </span><span class="s2">&quot;arn:aws:ec2:*:*:instance/*&quot;</span>
</span><span id="__span-56-20"><span class="w">  </span><span class="p">]</span>
</span><span id="__span-56-21"><span class="p">},</span>
</span></code></pre></div>
<h2 id="the-lava-ec2-ami">The Lava EC2 AMI<a class="headerlink" href="#the-lava-ec2-ami" title="Permanent link">&para;</a></h2>
<p>The lava worker utilises a suite of external capabilities on the host platform.
Examples include:</p>
<ul>
<li>A stable and predictable Linux O/S</li>
<li>A compatible version of Python</li>
<li>Docker</li>
<li>The Postgres, MySQL and Oracle CLI binaries</li>
<li>The Oracle driver and SQL*Plus binary</li>
<li>UnixODBC and FreeTDS for accessing MSSQL databases</li>
<li>AWS RDS and Redshift trust certificates</li>
<li>AWS SSM agent for host maintenance</li>
<li>AWS CloudWatch logs agent</li>
<li>Some of the platform dependent Python packages (e.g. psutil).</li>
</ul>
<p>... and, of course, ...</p>
<ul>
<li>The lava worker code bundle.</li>
</ul>
<p>The lava EC2 AMI incorporates all of the required components, except for the
lava code bundle itself, which is loaded from S3 at boot time.
This makes it easier to roll the
deployed lava version forward/backward just by changing an entry in the
<a href="04-dynamodb-tables.html#the-realms-table">realms table</a> and rebooting.</p>
<p>The lava AMI is based on Amazon Linux 2023. X86 and Graviton EC2 instances are
supported.</p>
<h3 id="lava-ami-names">Lava AMI Names<a class="headerlink" href="#lava-ami-names" title="Permanent link">&para;</a></h3>
<p>Lava AMI names look like so:</p>
<div class="language-bare highlight"><pre><span></span><code><span id="__span-57-1"><span class="err">lava-8.1.0-amzn2023-py3.11-arm64-2025-07-02T08-43-48Z</span>
</span><span id="__span-57-2"><span class="w">     </span><span class="err">--+--</span><span class="w"> </span><span class="err">---+----</span><span class="w"> </span><span class="err">--+---</span><span class="w"> </span><span class="err">--+--</span><span class="w"> </span><span class="err">----------+---------</span>
</span><span id="__span-57-3"><span class="w">       </span><span class="err">|</span><span class="w">      </span><span class="err">|</span><span class="w">       </span><span class="err">|</span><span class="w">      </span><span class="err">|</span><span class="w">             </span><span class="err">|</span>
</span><span id="__span-57-4"><span class="w">       </span><span class="err">|</span><span class="w">     </span><span class="err">O/S</span><span class="w">      </span><span class="err">|</span><span class="w"> </span><span class="err">Architecture</span><span class="w">       </span><span class="err">|</span>
</span><span id="__span-57-5"><span class="w">       </span><span class="err">|</span><span class="w">      </span><span class="err">|</span><span class="w">       </span><span class="err">|</span><span class="w">                    </span><span class="err">|</span>
</span><span id="__span-57-6"><span class="w">     </span><span class="err">lava</span><span class="w">     </span><span class="err">|</span><span class="w">    </span><span class="err">Python</span><span class="w">                </span><span class="err">Build</span>
</span><span id="__span-57-7"><span class="w">    </span><span class="err">Version</span><span class="w">   </span><span class="err">|</span><span class="w">    </span><span class="err">Version</span><span class="w">               </span><span class="err">Date</span>
</span><span id="__span-57-8"><span class="w">              </span><span class="err">|</span><span class="w">       </span><span class="err">|</span>
</span><span id="__span-57-9"><span class="w">              </span><span class="err">+---+---+</span>
</span><span id="__span-57-10"><span class="w">                  </span><span class="err">|</span>
</span><span id="__span-57-11"><span class="w">               </span><span class="err">Runtime</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With AMI names, the architecture for ARM is always <code>arm64</code>, never <code>aarch64</code>.
Lava worker code bundles for ARM can have either <code>arm64</code> or <code>aarch64</code>,
depending on how the target operating system identifies its platform. You
say tomato ... (Google it Grasshopper).</p>
</div>
<h3 id="lava-ami-architecture">Lava AMI Architecture<a class="headerlink" href="#lava-ami-architecture" title="Permanent link">&para;</a></h3>
<p>The lava AMI can be built for different CPU architectures. Typically this is one
of <code>x86_64</code> or <code>arm64</code>.</p>
<p>This can affect lava job payloads for <a href="06-jobs-job-types.html#job-type-pkg">pkg</a> jobs. If the payload
contains binary components, they may have a dependency on a particular machine
architecture.</p>
<h3 id="lava-ami-versions">Lava AMI Versions<a class="headerlink" href="#lava-ami-versions" title="Permanent link">&para;</a></h3>
<p>Lava AMI versions are derived from the version number of a given lava release
(e.g. v8.1.0). While there is generally not a hard binding between the lava
worker version and the AMI version, its best to keep them as close to in-sync
as possible.</p>
<h3 id="python-versions-in-the-lava-ami">Python Versions in the Lava AMI<a class="headerlink" href="#python-versions-in-the-lava-ami" title="Permanent link">&para;</a></h3>
<p>The lava AMI can be built with different Python versions. This can affect lava
job payloads for <a href="06-jobs-job-types.html#job-type-pkg">pkg</a> jobs. If the payload contains Python
components, they may have a dependency on a particular version of Python.</p>
<p>The Python version for a lava AMI is also indicated in the <code>PYTHON_VERSION</code> tag
on the AMI, and also in the AMI name.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If possible, use the <code>PYTHON_VERSION</code> tag in preference to the AMI name if
checking for Python version in case of future name structure changes.</p>
</div>
<h3 id="building-the-lava-ami">Building the Lava AMI<a class="headerlink" href="#building-the-lava-ami" title="Permanent link">&para;</a></h3>
<p>The lava AMI is built using <a href="https://www.packer.io">packer</a>. Most of the
components for the build are in the <code>ami</code> directory in the lava repo. Some
components (e.g. large 3rd party code bundles like the Oracle drivers) must be
loaded to a specified location in S3 prior to the build. The build process will
do this for you. This is done to speed up the build process as it avoids the
need to transfer these to the build instance at build time.</p>
<p>The build process leaves the following artefacts on the AMI in <code>~ec2-user/packer</code>:</p>
<ul>
<li>
<p>The build components</p>
</li>
<li>
<p>The detailed log from the build.</p>
</li>
</ul>
<p>The packer executable is also installed.</p>
<p>In theory, an instance based on the lava AMI can be used to rebuild the AMI
itself.</p>
<p>The essence of the process to build the AMI is:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-58-1"><span class="c1"># Make sure the lava virtualenv is activated first!</span>
</span><span id="__span-58-2">
</span><span id="__span-58-3"><span class="c1"># From the top of the lava source repo...</span>
</span><span id="__span-58-4"><span class="nb">cd</span><span class="w"> </span>ami
</span><span id="__span-58-5">
</span><span id="__span-58-6"><span class="c1"># Get some help, just in case...</span>
</span><span id="__span-58-7">make<span class="w"> </span><span class="nb">help</span>
</span><span id="__span-58-8">
</span><span id="__span-58-9"><span class="c1"># Build the AMI...</span>
</span><span id="__span-58-10">make<span class="w"> </span>ami<span class="w"> </span><span class="nv">param</span><span class="o">=</span>value<span class="w"> </span>...
</span></code></pre></div>
<p>This will first sync the required S3 based components from the local
filesystem to S3 and then initiate the <a href="https://www.packer.io">packer</a> build. A
number of tags are added to the resultant image to record things such as the
corresponding lava version and the installed Python version.</p>
<p>The trick to the process is getting the build parameters right for the target
environment. These are either specified on the <strong>make</strong> command line with the
<code>param=value</code> arguments (the <a href="#the-hard-way-specifying-build-parameters-manually">hard way</a>)
or obtained from a configuration file
(the <a href="#the-easy-way-reading-build-parameters-from-a-configuration-file">easy way</a>).</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ami_id</td>
<td>No</td>
<td>ID of the base AMI. If not specified, the <code>ami_ref</code> is read from <code>ami-build.yaml</code>, which is then used to lookup the AMI ID. Don't mess with this unless you really know what you're doing.</td>
</tr>
<tr>
<td>ami_ref</td>
<td>No</td>
<td>The <code>ami_ref</code> is the tail of an AWS SSM parameter name containing the ID of the base AMI. AWS provides a bunch of these parameters to simplify finding common AMIs. e.g. <code>al2023-ami-kernel-default-x86_64</code>. See https://docs.aws.amazon.com/linux/al2023/ug/ec2.html. If not specified, the <code>os</code> is looked up in <code>ami-build.yaml</code> to obtain the value.</td>
</tr>
<tr>
<td>arch</td>
<td>No</td>
<td>The CPU architecture. This must be one of <code>x86_64</code> (default) or <code>arm64</code>.</td>
</tr>
<tr>
<td>config</td>
<td>No</td>
<td>Name of a YAML configuration file (in lava deploy format) containing values for any or all of the required parameters. A configuration file can contain separate configurations for different environments (e.g. dev, prod etc.). If specified, the <code>env</code> parameter is also required. The AMI configuration parameters are specified under the <code>&lt;ENV&gt; -&gt; ami</code> key. A sample configuration file can be found in <code>deploy/sample.yaml</code>.</td>
</tr>
<tr>
<td>env</td>
<td>No</td>
<td>The environment identifier within a specified configuration file.</td>
</tr>
<tr>
<td>os</td>
<td>Yes</td>
<td>The O/S type of the AMI to be built. Allowed values are specified in <code>ami-build.yaml</code> and must correspond to a builder in the <code>os</code> directory. Currently supported values are <code>amzn2</code> (Amazon Linux 2) and <code>amzn2023</code> (Amazon Linux 2023).</td>
</tr>
<tr>
<td>instance_type</td>
<td>No</td>
<td>The AWS EC2 build instance type. This must match the CPU architecture specified by <code>arch</code>. e.g. If the <code>arch</code> is <code>arm64</code>, a Graviton build instance must be selected. If not specified, the value is read from <code>ami-build.yaml</code>.</td>
</tr>
<tr>
<td>ip</td>
<td>Yes</td>
<td>IP address type for the packer build instance. Either <code>public</code> or <code>private</code></td>
</tr>
<tr>
<td>python_version</td>
<td>Yes</td>
<td>The Python version to build from source for the AMI (e.g. <code>3.11.12</code>).</td>
</tr>
<tr>
<td>s3bucket</td>
<td>Yes</td>
<td>Name of the S3 bucket containing extra build resources (e.g. Oracle client binaries).</td>
</tr>
<tr>
<td>s3prefix</td>
<td>Yes</td>
<td>The S3 prefix containing extra build resources (e.g. Oracle client binaries).</td>
</tr>
<tr>
<td>sg</td>
<td>Yes</td>
<td>Security group ID (or a comma separated list of IDs) for the packer build instance.</td>
</tr>
<tr>
<td>subnet</td>
<td>Yes</td>
<td>Subnet ID for the packer build instance.</td>
</tr>
<tr>
<td>tz</td>
<td>Yes</td>
<td>Timezone to set in instances created from the lava AMI (e.g. <code>Australia/Sydney</code>)</td>
</tr>
</tbody>
</table>
<h4 id="the-hard-way-specifying-build-parameters-manually">The Hard Way - Specifying Build Parameters Manually<a class="headerlink" href="#the-hard-way-specifying-build-parameters-manually" title="Permanent link">&para;</a></h4>
<p>The required configuration parameters can all be specified as part of the <strong>make</strong>
command line, like so:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-59-1">make<span class="w"> </span>ami<span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-2"><span class="w">    </span><span class="nv">ami_id</span><span class="o">=</span><span class="s2">&quot;ami-0043df2e553ad12b6&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-3"><span class="w">    </span><span class="nv">ip</span><span class="o">=</span><span class="s2">&quot;public&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-4"><span class="w">    </span><span class="nv">python_version</span><span class="o">=</span><span class="s2">&quot;3.11.12&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-5"><span class="w">    </span><span class="nv">s3bucket</span><span class="o">=</span><span class="s2">&quot;my-artefact-bucket&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-6"><span class="w">    </span><span class="nv">s3prefix</span><span class="o">=</span><span class="s2">&quot;lava/ami/&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-7"><span class="w">    </span><span class="nv">sg</span><span class="o">=</span><span class="s2">&quot;sg-004d25956a3bf5bd4&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-8"><span class="w">    </span><span class="nv">subnet</span><span class="o">=</span><span class="s2">&quot;subnet-f6b6d681&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-59-9"><span class="w">    </span><span class="nv">tz</span><span class="o">=</span><span class="s2">&quot;Australia/Sydney&quot;</span>
</span></code></pre></div>
<p>This gets old very quickly when building for multiple environments.</p>
<h4 id="the-easy-way-reading-build-parameters-from-a-configuration-file">The Easy Way - Reading Build Parameters from a Configuration File<a class="headerlink" href="#the-easy-way-reading-build-parameters-from-a-configuration-file" title="Permanent link">&para;</a></h4>
<p>All of the mandatory build parameters can be placed in a YAML configuration file
(let's call it <code>config.yaml</code>) formatted like so:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-60-1"><span class="c1"># This is the config for the &quot;dev&quot; environment. The file can contain</span>
</span><span id="__span-60-2"><span class="c1"># multiple environments.</span>
</span><span id="__span-60-3"><span class="nt">dev</span><span class="p">:</span>
</span><span id="__span-60-4"><span class="w">  </span><span class="c1"># The underscore key is for general config</span>
</span><span id="__span-60-5"><span class="w">  </span><span class="nt">_</span><span class="p">:</span>
</span><span id="__span-60-6"><span class="w">    </span><span class="c1"># If other S3 location keys don&#39;t start with s3:// this base is used.</span>
</span><span id="__span-60-7"><span class="w">    </span><span class="c1"># Don&#39;t add trailing / here.</span>
</span><span id="__span-60-8"><span class="w">    </span><span class="nt">s3base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-bucket/a/prefix</span>
</span><span id="__span-60-9">
</span><span id="__span-60-10"><span class="w">  </span><span class="c1"># Parameters for packer when building the lava ami.</span>
</span><span id="__span-60-11"><span class="w">  </span><span class="nt">ami</span><span class="p">:</span>
</span><span id="__span-60-12"><span class="w">    </span><span class="c1"># Location of additional resources for building the lava AMI.</span>
</span><span id="__span-60-13"><span class="w">    </span><span class="nt">s3</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lava/ami/</span>
</span><span id="__span-60-14"><span class="w">    </span><span class="c1"># Public or private IP address for the build</span>
</span><span id="__span-60-15"><span class="w">    </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">public</span>
</span><span id="__span-60-16"><span class="w">    </span><span class="c1"># Build instance subnet</span>
</span><span id="__span-60-17"><span class="w">    </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-f6b6d681</span>
</span><span id="__span-60-18"><span class="w">    </span><span class="c1"># Security groups -- this must be a comma separated list (no spaces)</span>
</span><span id="__span-60-19"><span class="w">    </span><span class="nt">sg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sg-004d25956a3bf5bd4</span>
</span><span id="__span-60-20"><span class="w">    </span><span class="c1"># Timezone set on instances created from the AMI.</span>
</span><span id="__span-60-21"><span class="w">    </span><span class="nt">tz</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Australia/Sydney</span>
</span><span id="__span-60-22"><span class="w">    </span><span class="c1"># Python version to build from source</span>
</span><span id="__span-60-23"><span class="w">    </span><span class="nt">python</span><span class="p">:</span>
</span><span id="__span-60-24"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.11.12&quot;</span>
</span></code></pre></div>
<p>The configuration file is in lava standard deploy format and may also contain
other parameters for deploying the lava code bundles to S3 etc. A sample version
is provided in <code>deploy/sample.yaml</code>.</p>
<p>The AMI build process then becomes:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-61-1">make<span class="w"> </span>ami<span class="w"> </span><span class="nv">config</span><span class="o">=</span>config.yaml<span class="w"> </span><span class="nv">env</span><span class="o">=</span>dev
</span></code></pre></div>
<p>It is still possible to override individual parameters like so:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-62-1">make<span class="w"> </span>ami<span class="w"> </span><span class="nv">config</span><span class="o">=</span>config.yaml<span class="w"> </span><span class="nv">env</span><span class="o">=</span>dev<span class="w"> </span><span class="nv">python_version</span><span class="o">=</span><span class="m">3</span>.11.11
</span></code></pre></div>
<h3 id="user-data-for-the-lava-ami">User Data for the Lava AMI<a class="headerlink" href="#user-data-for-the-lava-ami" title="Permanent link">&para;</a></h3>
<p>When a lava AMI instance boots, the normal Linux boot process will eventually
get around to running <code>/etc/rc.local</code>. At the end of this, a lava AMI specific
process runs all of the scripts in the directory <code>/usr/local/etc/rc.d</code>. A number
of these scripts examine the EC2 instance user data, expecting to find a JSON
formatted object which they search for keys that provide configuration
instructions.</p>
<p>The following keys are currently supported in the user data JSON. All of the
top level keys are optional. If not present, the relevant script will take no
action.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Sub-key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>crontab</td>
<td><code>&lt;USER_NAME&gt;</code></td>
<td>A dictionary of Linux instance user names. The value for each user name is the name of an S3 object containing the crontab for that user.</td>
</tr>
<tr>
<td>shell</td>
<td>-</td>
<td>A string (or list of strings) containing a command (or list of commands) to run. This runs after all the other startup scripts have run. This is used by the lava <a href="#the-lava-worker-cloudformation-template">worker CloudFormation template</a> to invoke the lava installer to download, install and run the lava worker code on boot.</td>
</tr>
<tr>
<td>shell0</td>
<td>-</td>
<td>Same as the <code>shell</code> key except this runs before any of the other scripts.</td>
</tr>
<tr>
<td>swap</td>
<td>size</td>
<td>If present and non-zero, swapping is enabled. The value is the swap file size in Gibibytes (1024 * 1024 * 1024 bytes). The swap file is on the root volume so there must be adequate space to hold it. More information on <a href="https://www.linux.com/news/all-about-linux-swap-space/">swap space</a> and <a href="https://help.ubuntu.com/community/SwapFaq#How_much_swap_do_I_need.3F">swap file size selection</a>.</td>
</tr>
<tr>
<td>swap</td>
<td>file</td>
<td>Name of the swap file. It must be on the root volume. The default is <code>/swapfile</code>.</td>
</tr>
</tbody>
</table>
<p>For example, the following user-data will cause a lava AMI based instance to:</p>
<ul>
<li>
<p>Install a crontab file for users <code>ec2-user</code> and <code>root</code>.</p>
</li>
<li>
<p>Enable swapping with swap file of 2GiB.</p>
</li>
<li>
<p>Run a couple of shell commands.</p>
</li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-63-1"><span class="p">{</span>
</span><span id="__span-63-2"><span class="w">  </span><span class="nt">&quot;swap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-3"><span class="w">    </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-63-4"><span class="w">    </span><span class="nt">&quot;file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/swap_till_you_drop&quot;</span>
</span><span id="__span-63-5"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-63-6"><span class="w">  </span><span class="nt">&quot;crontab&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-7"><span class="w">    </span><span class="nt">&quot;ec2-user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3://mybucket/ec2config/latest/ec2-user.cron&quot;</span><span class="p">,</span>
</span><span id="__span-63-8"><span class="w">    </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3://mybucket/ec2config/latest/root.cron&quot;</span>
</span><span id="__span-63-9"><span class="w">  </span><span class="p">},</span>
</span><span id="__span-63-10"><span class="w">  </span><span class="nt">&quot;shell&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-63-11"><span class="w">    </span><span class="s2">&quot;echo Hello world&quot;</span><span class="p">,</span>
</span><span id="__span-63-12"><span class="w">    </span><span class="s2">&quot;echo Resistance is futile &gt; /tmp/borg&quot;</span>
</span><span id="__span-63-13"><span class="w">  </span><span class="p">]</span>
</span><span id="__span-63-14"><span class="p">}</span>
</span></code></pre></div>
<h3 id="configuring-a-lava-worker-ec2-instance-to-use-a-lava-ami">Configuring a Lava Worker EC2 Instance to Use a Lava AMI<a class="headerlink" href="#configuring-a-lava-worker-ec2-instance-to-use-a-lava-ami" title="Permanent link">&para;</a></h3>
<p>The AMI used by an EC2 based lava worker is specified as a parameter in the
<a href="#the-lava-worker-cloudformation-template">worker CloudFormation template</a>.</p>
<p>The template creates the necessary EC2 launch template and auto scaler and
also ensures the instance user data is correctly constructed to install and
start the lava worker(s) on boot.</p>
<p>To select or change the AMI, simply update the relevant worker CloudFormation
stack. While this can be done from the AWS console, it is more convenient to use
the <a href="16-commands-utilities.html#lava-ami-utility">lava-ami</a> utility which displays the available, lava
compatible, AMIs and the AMI specified in each lava worker CloudFormation stack.
It also provides an update mode that allows a (more or less) interactive process
to select and apply a different AMI to one or more lava worker stacks.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; Origin Energy 2025
    </div>
  
</div>
      <div class="md-footer-social">
        <div class="md-copyright">
          <div class="md-copyright__highlight">
            v8.2.0 (Kilauea)
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["navigation.instant", "content.code.copy", {"icon": {"repo": "material/github"}}], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>